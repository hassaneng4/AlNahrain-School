<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاكاة التطبيق - إعدادية النهرين</title>
    <style>
        /* PHONE SIMULATION FRAME */
        @media (min-width: 600px) {
            body {
                background-color: #1a1a1a !important;
                background-image: radial-gradient(#333 1px, transparent 1px);
                background-size: 20px 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
            }

            #sim-device-frame {
                width: 375px;
                height: 800px;
                background: #000;
                border: 12px solid #333;
                border-radius: 40px;
                box-shadow: 0 0 50px rgba(0, 242, 255, 0.3);
                overflow: hidden;
                position: relative;
                /* TRICK: This forces Fixed elements inside to be relative to this frame! */
                transform: translateZ(0);
            }

            #sim-device-notch {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 150px;
                height: 30px;
                background: #333;
                border-bottom-left-radius: 15px;
                border-bottom-right-radius: 15px;
                z-index: 9999;
            }

            /* Status Bar (Simulated) */
            .status-bar {
                position: absolute;
                top: 5px;
                left: 0;
                width: 100%;
                height: 25px;
                padding: 0 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: 10000;
                color: #fff;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                font-size: 14px;
                font-weight: 600;
                direction: ltr;
                /* Keep standard layout */
                pointer-events: none;
            }

            /* Home Indicator */
            .home-indicator {
                position: absolute;
                bottom: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 130px;
                height: 5px;
                background: rgba(255, 255, 255, 0.4);
                border-radius: 100px;
                z-index: 10001;
                pointer-events: none;
            }

            /* Scrollbar hiding inside frame */
            #sim-content-wrapper {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                scrollbar-width: none;
                position: relative;
            }

            #sim-content-wrapper::-webkit-scrollbar {
                display: none;
            }

            /* FORCE MOBILE STYLES WITHIN SIM */
            /* The following rules are now superseded by APP-LIKE UI TRANSFORMATION */
            /* #sim-content-wrapper nav {
                position: absolute !important;
                width: 100% !important;
                top: 0 !important;
                padding: 10px !important;
            } */

            #sim-content-wrapper .nav-items {
                display: none !important;
            }

            /* Hide Desktop Menu */
            #sim-content-wrapper .auth-box,
            #sim-content-wrapper .hero-content {
                text-align: center !important;
                width: 100% !important;
                padding: 20px !important;
            }

            #sim-content-wrapper .hero {
                padding-top: 80px !important;
            }

            /* Fix Floating Elements */
            #sim-content-wrapper a[href="#admission-section"] {
                /* The floating Apply Btn */
                position: absolute !important;
                top: auto !important;
                bottom: 80px !important;
                left: 50% !important;
                transform: translateX(-50%) scale(0.9) !important;
                width: 90%;
            }

            #sim-content-wrapper #ai-orb {
                position: absolute !important;
                bottom: 20px !important;
                right: 20px !important;
            }

            /* APP-LIKE UI TRANSFORMATION */

            /* 1. Hide Web Nav */
            #sim-content-wrapper nav {
                display: none !important;
            }

            /* 2. App Header (Sticky Top) */
            .app-header {
                position: sticky;
                top: 0;
                background: rgba(10, 10, 10, 0.95);
                backdrop-filter: blur(10px);
                padding: 45px 20px 15px 20px;
                /* Top padding increased for Status Bar/Notch */
                border-bottom: 1px solid #333;
                z-index: 1000;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                /* Subtle Shadow */
            }

            .app-header h1 {
                margin: 0;
                font-size: 1.2rem;
                color: #fff;
            }

            .app-header i {
                font-size: 1.2rem;
                color: var(--primary);
            }

            /* 3. Bottom Navigation Bar */
            .app-bottom-nav {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 80px !important;
                /* Slightly taller for Home Indicator area */
                background: rgba(10, 10, 10, 0.9) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-radius: 0 0 30px 30px !important;
                /* MATCH DEVICE CORNERS */

                display: flex !important;
                justify-content: space-around !important;
                align-items: center !important;
                z-index: 9999 !important;
                padding-bottom: 20px !important;
                /* Lift icons above Home Indicator */
                margin: 0 !important;
                transform: none !important;
            }

            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                color: #555;
                font-size: 0.7rem;
                text-decoration: none;
                transition: 0.3s;
            }

            .nav-item i {
                font-size: 1.4rem;
                margin-bottom: 5px;
            }

            .nav-item.active {
                color: var(--primary);
            }

            /* 4. Content Adjustments */
            #sim-content-wrapper {
                padding-bottom: 80px;
                background: #080808;
            }

            /* Space for Bottom Nav */
            #sim-content-wrapper .hero {
                min-height: auto !important;
                padding: 20px !important;
                text-align: center;
            }

            #sim-content-wrapper .hero h1 {
                font-size: 1.8rem !important;
            }

            #sim-content-wrapper .floating-badge {
                font-size: 0.8rem;
                padding: 5px 10px;
            }

            /* Hide Section Titles/Padding for compact look */
            #sim-content-wrapper section {
                padding: 30px 15px !important;
            }

            #sim-content-wrapper .section-title h2 {
                font-size: 1.5rem;
            }

            /* Hide the big floating button from web view */
            #sim-content-wrapper a[href="#admission-section"] {
                display: none !important;
            }

            /* FAB (Floating Action Button) for Apply */
            .fab-apply {
                position: absolute;
                bottom: 90px;
                left: 20px;
                width: 50px;
                height: 50px;
                background: var(--secondary);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
                z-index: 1000;
                color: #fff;
                font-size: 1.2rem;
                animation: pulse-fab 2s infinite;
            }

            @keyframes pulse-fab {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.4);
                }

                70% {
                    box-shadow: 0 0 0 10px rgba(255, 0, 85, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(255, 0, 85, 0);
                }
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FIREBASE SDKs (Cloud & Auth) -->
    <!-- SIMULATION MODE: MOCK FIREBASE -->
    <script>
        console.log("⚠️ SIMULATION MODE ACTIVE");
        window.isSimulation = true;

        // Mock Data Store
        const simDB = {
            users: {},
            schoolDB: { apps: [], students: {}, staff: {} }
        };

        // Mock Firebase Object
        const firebase = {
            initializeApp: () => console.log("🟢 Sim Firebase Initialized"),
            auth: () => ({
                createUserWithEmailAndPassword: (e, p) => {
                    console.log(`Sim Register: ${e}`);
                    return Promise.resolve({ user: { uid: 'sim_' + Date.now() } });
                },
                signInWithEmailAndPassword: (e, p) => {
                    if (e === 'admin@school.com' && p === '123456') return Promise.resolve({ user: { uid: 'admin_sim' } });
                    return Promise.resolve({ user: { uid: 'sim_user' } });
                },
                signOut: () => Promise.resolve(),
                onAuthStateChanged: (cb) => { } // No auto-login in sim
            }),
            database: () => ({
                ref: (path) => {
                    const mockRef = {
                        on: (evt, cb) => console.log(`Sim Listen: ${path}`),
                        once: (evt) => Promise.resolve({ val: () => simDB[path] || {} }),
                        set: (d) => { console.log(`Sim Set ${path}:`, d); return Promise.resolve(); },
                        push: (d) => {
                            console.log(`Sim Push ${path}:`, d);
                            // primitive mock push
                            if (path.includes('apps')) simDB.schoolDB.apps.push(d);
                            return Promise.resolve();
                        },
                        update: (d) => { console.log(`Sim Update ${path}:`, d); return Promise.resolve(); },
                        child: (c) => firebase.database().ref(path ? path + '/' + c : c)
                    };
                    return mockRef;
                }
            })
        };
        const dbRef = firebase.database().ref();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f2ff">
    <link rel="apple-touch-icon" href="logo.jpg">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #271242;
            --dark-bg: #050505;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-strong: rgba(20, 20, 30, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-glow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) var(--dark-bg);
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--dark-bg);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- PRELOADER (BOOT SEQUENCE) --- */
        #boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: monospace;
            color: var(--primary);
            direction: ltr;
        }

        .boot-log {
            font-size: 1rem;
            margin-bottom: 5px;
            opacity: 0;
        }

        .boot-progress {
            width: 300px;
            height: 4px;
            background: #333;
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }

        .boot-bar {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.2s;
            box-shadow: 0 0 10px var(--primary);
        }

        /* --- Dynamic Background & UI --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #0a0a20 0%, #000000 100%);
        }

        .cursor-glow {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 242, 255, 0.15) 0%, transparent 70%);
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            mix-blend-mode: screen;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* --- News Ticker --- */
        .news-ticker {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid var(--primary);
            padding: 10px 0;
            z-index: 9998;
            display: flex;
            align-items: center;
        }

        .ticker-label {
            background: var(--primary);
            color: #000;
            padding: 5px 15px;
            font-weight: bold;
            margin: 0 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px var(--primary);
            white-space: nowrap;
        }

        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-content {
            display: inline-block;
            animation: ticker 30s linear infinite;
            color: #ddd;
        }

        .ticker-item {
            margin-left: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .ticker-item i {
            color: var(--secondary);
        }

        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* --- Typography & Titles --- */
        h1,
        h2,
        h3,
        h4 {
            color: #fff;
        }

        .section-title {
            text-align: center;
            margin: 80px 0 50px;
            position: relative;
        }

        .section-title h2 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .section-title p {
            color: #aaa;
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* --- Glitch Text --- */
        .glitch-text {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
        }

        .glitch-text::before {
            left: 2px;
            text-shadow: -1px 0 var(--secondary);
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }

        .glitch-text::after {
            left: -2px;
            text-shadow: -1px 0 var(--primary);
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% {
                clip: rect(10px, 9999px, 31px, 0);
            }

            100% {
                clip: rect(30px, 9999px, 80px, 0);
            }
        }

        @keyframes glitch-anim-2 {
            0% {
                clip: rect(95px, 9999px, 10px, 0);
            }

            100% {
                clip: rect(40px, 9999px, 90px, 0);
            }
        }

        /* --- Navigation --- */
        nav {
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 1400px;
            z-index: 1000;
            background: var(--glass-strong);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            backdrop-filter: blur(20px);
        }

        .logo img {
            height: 50px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-items {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: #ccc;
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
            font-size: 1rem;
        }

        .nav-link:hover {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .btn-glow {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: #fff;
            padding: 10px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(112, 0, 255, 0.4);
            transition: 0.3s;
            border: none;
            cursor: pointer;
            display: inline-block;
        }

        .btn-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.6);
        }

        /* --- Sections --- */
        .hero {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            padding-top: 80px;
        }

        .hero-content h1 {
            font-size: 4.5rem;
            line-height: 1.2;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .hero-content p {
            font-size: 1.5rem;
            color: #ddd;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .floating-badge {
            display: inline-block;
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--primary);
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }

        .stat-card {
            background: var(--glass-strong);
            padding: 30px;
            text-align: center;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            transition: 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary);
            display: block;
        }

        .vision-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .vision-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 40px;
            border-radius: 20px;
            border-right: 3px solid var(--secondary);
            transition: 0.3s;
        }

        .vision-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary);
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .cards-grid-small {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .spec-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: 0.4s;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .spec-card:hover {
            border-color: var(--secondary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .spec-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: inline-block;
            animation: float-icon 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.3));
            transition: transform 0.3s;
        }

        @keyframes float-icon {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .spec-card:hover .spec-icon {
            transform: scale(1.3) translateZ(20px);
            filter: drop-shadow(0 0 20px var(--primary));
        }

        .spec-card h4 {
            font-size: 1.2rem;
            margin-top: 10px;
            transform: translateZ(10px);
        }

        #portals {
            padding: 100px 0;
            background: linear-gradient(to bottom, transparent, rgba(0, 242, 255, 0.05), transparent);
        }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 50px;
        }

        .portal-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .portal-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.15);
        }

        .portal-card h3 {
            font-size: 1.5rem;
            margin: 15px 0;
        }

        /* --- Dashboard & Login Overlays --- */
        .dashboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 50px;
            overflow-y: auto;
            display: none;
            backdrop-filter: blur(10px);
        }

        .dashboard-overlay.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .close-dash {
            position: absolute;
            top: 30px;
            left: 30px;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            transition: 0.3s;
        }

        .close-dash:hover {
            color: var(--primary);
            transform: rotate(90deg);
        }

        /* Login Screen Styles */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .auth-box {
            background: var(--glass-strong);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--primary);
            width: 400px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.2);
        }

        .auth-box h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .auth-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            color: #fff;
            border-radius: 10px;
            font-family: 'Cairo';
            text-align: center;
            font-size: 1.2rem;
        }

        .auth-box button {
            width: 100%;
        }

        /* --- Tables & Inputs --- */
        .cyber-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 20px;
        }

        .cyber-table th {
            text-align: right;
            padding: 15px;
            color: #888;
        }

        .cyber-table td {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Gradebook Styles */
        .gradebook-table th,
        .gradebook-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 0.9rem;
            color: #000;
        }

        .gradebook-table th {
            background: #d0e0e3;
            font-weight: bold;
        }

        .gradebook-table input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-family: 'Cairo';
            color: #000;
        }

        .gradebook-table input:focus {
            background: #ffffcc;
            outline: none;
        }

        .cyber-table td:first-child {
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 10px 10px 0;
        }

        .cyber-table td:last-child {
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px 0 0 10px;
        }

        .grade-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .grade-good {
            color: #0f0;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #0f0;
        }

        .cyber-input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            color: #fff;
            border-radius: 10px;
            margin-bottom: 15px;
            font-family: 'Cairo';
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- AI Assistant --- */
        #ai-orb {
            position: fixed;
            bottom: 70px;
            right: 30px;
            width: 80px;
            height: 80px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        #ai-orb:hover {
            transform: scale(1.1);
        }

        .orb-core {
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 20px #fff, 0 0 40px var(--primary);
            z-index: 2;
            animation: pulse-core 2s infinite;
        }

        .orb-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(0, 242, 255, 0.5);
            box-shadow: 0 0 15px var(--primary);
        }

        .ring-1 {
            width: 60px;
            height: 60px;
            animation: spin-right 4s linear infinite;
            border-top-color: transparent;
        }

        .ring-2 {
            width: 70px;
            height: 70px;
            animation: spin-left 6s linear infinite;
            border-left-color: transparent;
            border-color: rgba(112, 0, 255, 0.5);
        }

        .ring-3 {
            width: 80px;
            height: 80px;
            animation: pulse-ring 3s infinite;
            border: 1px dashed rgba(255, 255, 255, 0.3);
        }

        @keyframes pulse-core {
            0% {
                box-shadow: 0 0 20px #fff, 0 0 40px var(--primary);
            }

            50% {
                box-shadow: 0 0 30px #fff, 0 0 60px var(--primary), 0 0 80px var(--secondary);
            }

            100% {
                box-shadow: 0 0 20px #fff, 0 0 40px var(--primary);
            }
        }

        @keyframes spin-right {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes spin-left {
            100% {
                transform: rotate(-360deg);
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        #ai-interface {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 350px;
            height: 0;
            overflow: hidden;
            z-index: 9999;
            transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
        }

        #ai-interface.open {
            height: 500px;
            border-color: var(--primary);
        }

        .ai-header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-ai {
            cursor: pointer;
        }

        #ai-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-msg {
            background: rgba(0, 242, 255, 0.1);
            padding: 12px;
            border-radius: 15px 15px 2px 15px;
            align-self: flex-end;
            color: #fff;
            border: 1px solid rgba(0, 242, 255, 0.2);
            max-width: 90%;
            font-size: 0.9rem;
            direction: rtl;
        }

        .user-msg {
            background: rgba(112, 0, 255, 0.2);
            border-radius: 15px 15px 15px 2px;
            align-self: flex-start;
            border: 1px solid rgba(112, 0, 255, 0.3);
        }

        .ai-suggestions {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .ai-suggestions button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--primary);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.8rem;
        }

        .ai-suggestions button:hover {
            background: var(--primary);
            color: #000;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                text-shadow: 0 0 10px var(--secondary);
            }

            50% {
                transform: scale(1.1);
                text-shadow: 0 0 20px var(--secondary);
            }

            100% {
                transform: scale(1);
                text-shadow: 0 0 10px var(--secondary);
            }
        }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }

            .hero {
                flex-direction: column;
                height: auto;
                padding-top: 120px;
                padding-bottom: 50px;
                text-align: center;
            }

            .hero-content {
                width: 100%;
                padding: 0 20px;
                margin-bottom: 40px;
            }

            .hero-content h1 {
                font-size: 2.5rem;
                line-height: 1.2;
            }

            .login-sidebar {
                width: 90%;
                max-width: 400px;
            }

            /* Stack All Grids */
            .vision-grid,
            .portal-grid,
            .container[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 20px;
                padding: 0 20px;
            }

            /* Adjust Spacing */
            section {
                padding-top: 60px !important;
                padding-bottom: 60px !important;
                margin-top: 50px !important;
            }

            /* AI Interface */
            #ai-orb {
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
            }

            #ai-interface {
                width: 92%;
                right: 4%;
                bottom: 90px;
            }

            /* Fix Tables Overflow */
            div[class*="glass-panel"] {
                overflow-x: hidden;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #student-dash,
            #student-dash * {
                visibility: visible;
            }

            #student-dash {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white !important;
                color: black !important;
            }

            .close-dash,
            .action-btn,
            .btn-glow,
            #ai-orb {
                display: none !important;
            }

            .dashboard-overlay {
                background: white !important;
                z-index: 99999;
            }

            .glass-panel {
                border: 1px solid black;
                box-shadow: none;
                background: white;
                color: black;
            }

            h1,
            h2,
            h3,
            h4,
            p,
            span,
            td,
            th {
                color: black !important;
                text-shadow: none !important;
            }
        }

        /* --- AI ASSISTANT STYLES --- */
        #ai-orb {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px var(--primary);
            cursor: pointer;
            z-index: 5000;
            transition: 0.3s;
            animation: float 3s ease-in-out infinite;
        }

        #ai-orb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px var(--primary);
        }

        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--primary);
            animation: pulse-ring 2s infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        #ai-interface {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--primary);
            border-radius: 20px;
            display: none;
            flex-direction: column;
            z-index: 5000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        #ai-interface.open {
            display: flex;
            animation: slideUp 0.3s;
        }

        .ai-header {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            border-radius: 20px 20px 0 0;
        }

        #ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-msg {
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .ai-msg.bot {
            background: rgba(0, 242, 255, 0.1);
            border-left: 3px solid var(--primary);
            align-self: flex-start;
        }

        .ai-msg.user {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-end;
        }

        .ai-input-area {
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #333;
        }

        .ai-input-area input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Cairo';
            outline: none;
        }

        /* === MADRASA THEME STYLES === */
        :root {
            --m-bg: #0f172a;
            /* Deep Navy */
            --m-primary: #3b82f6;
            /* Bright Blue */
            --m-accent: #8b5cf6;
            /* Violet */
            --m-gold: #fbbf24;
            /* Star Gold */
            --m-card: rgba(30, 41, 59, 0.7);
        }

        /* Background: Deep Space Gradient (Madrasa Style) */
        #sim-device-frame {
            background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 100%) !important;
        }

        #sim-content-wrapper {
            background: transparent !important;
            font-family: 'Cairo', sans-serif !important;
            height: 100%;
            overflow-y: auto;
            /* Enable Scroll INSIDE wrapper */
            padding-bottom: 80px;
            /* Space for Bottom Nav */
            position: relative;
            /* Context for children */
        }

        /* Ensure frame is relative parent */
        #sim-device-frame {
            position: relative !important;
            overflow: hidden !important;
            /* contain visual bleed */
            display: flex;
            /* Flexbox to manage layout */
            flex-direction: column;
        }

        /* 1. Header: Gamified Profile */
        .app-header {
            background: rgba(15, 23, 42, 0.8) !important;
            backdrop-filter: blur(20px) !important;
            border-bottom: none !important;
            padding: 20px 25px !important;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 2. Cards: Premium Glass Style */
        .madrasa-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.03));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .madrasa-card:active {
            transform: scale(0.98);
        }

        /* 3. Bottom Nav: Floating Island (Safer & Prettier) */
        .app-bottom-nav {
            background: rgba(15, 23, 42, 0.90) !important;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 40px;
            /* Fully rounded capsule */
            position: absolute !important;
            bottom: 25px !important;
            /* Float up from margins */
            left: 5% !important;
            /* Center manually */
            width: 90% !important;
            /* Leave gaps on sides */
            max-width: 340px !important;
            height: 65px !important;
            padding: 0 10px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 9999;
        }

        /* Back Button Style */
        .back-btn {
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            margin-left: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            color: #94a3b8 !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            font-size: 0.7rem;
        }

        .nav-item.active {
            color: #fff !important;
            position: relative;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            width: 5px;
            height: 5px;
            background: var(--m-accent);
            border-radius: 50%;
        }

        .nav-item i {
            font-size: 1.5rem !important;
            margin-bottom: 8px !important;
        }

        /* Icons Enhancement */
        .icon-box-3d {
            width: 65px;
            height: 65px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px auto;
            font-size: 1.8rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        /* View Animations */
        .app-view {
            animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide Web Content Wrapper */
        #web-content-hidden {
            display: none;
        }

        /* === MOBILE RESPONSIVENESS FIXES (OVERRIDE) === */

        /* 1. Enable Vertical Scroll for Modals (Fix Keyboard Overlay) */
        .dashboard-overlay {
            align-items: flex-start !important;
            /* Allow top scrolling */
            padding-top: 20px;
            padding-bottom: 50px;
        }

        /* 2. Enable Horizontal Scroll for Tables (Fix Table Cutoff) */
        .table-wrapper,
        .glass-panel>div[style*="overflow-x"] {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            display: block;
        }

        /* 3. Mobile Specific Adjustments */
        @media (max-width: 768px) {
            .container {
                width: 95% !important;
                padding: 10px;
            }

            .glass-panel {
                padding: 15px !important;
            }

            /* Input Fields: Prevent Zoom & improve touch area */
            .cyber-input {
                font-size: 16px !important;
                /* Prevents iOS Zoom */
                padding: 12px !important;
                margin-bottom: 10px !important;
            }

            /* Buttons */
            .btn-glow {
                padding: 12px 20px !important;
                font-size: 1rem !important;
                width: 100%;
                /* Full width buttons on mobile */
                margin-bottom: 10px;
            }

            /* Tabs stacking */
            .tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .tabs button {
                width: 48% !important;
                /* 2 cols */
                font-size: 0.8rem !important;
            }

            /* Table Fonts */
            th,
            td {
                padding: 8px 5px !important;
                font-size: 0.85rem !important;
                white-space: nowrap;
                /* Keep rows single line, scroll horizontal */
            }
        }
    </style>
</head>

<body>
    <div id="sim-device-frame" style="position: relative !important;">
        <div id="sim-device-notch"></div>
        <!-- Simulated Status Bar -->
        <div class="status-bar">
            <div id="sb-time">19:38</div>
            <div style="display:flex; gap:6px; align-items:center;">
                <i class="fa-solid fa-signal" style="font-size:12px;"></i>
                <i class="fa-solid fa-wifi" style="font-size:12px;"></i>
                <i class="fa-solid fa-battery-full" style="font-size:14px;"></i>
            </div>
        </div>
        <script>
            // Update Status Bar Time
            function updateSBTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const timeStr = `${hours}:${minutes}`;
                const el = document.getElementById('sb-time');
                // Avoid blinking if sameTime
                if (el && el.innerText !== timeStr) el.innerText = timeStr;
            }
            setInterval(updateSBTime, 1000);
            updateSBTime();
        </script>
        <div id="sim-content-wrapper">
            <!-- APP CONTENT START -->
            <!-- APP CONTENT START -->

            <!-- 1. MADRASA HEADER (Customized for Al-Nahrain) -->
            <!-- 1. MADRASA HEADER (Customized for Al-Nahrain) -->
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <!-- Back Button (Hidden on Home) -->
                    <div id="app-back-btn" class="back-btn" onclick="switchAppTab('home')" style="display:none;">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>

                    <div
                        style="width:40px; height:40px; background:linear-gradient(45deg, #3b82f6, #8b5cf6); border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold;">
                        ن</div>
                    <div>
                        <span style="font-size:0.75rem; color:#94a3b8; display:block;">إعدادية النهرين</span>
                        <h1 style="font-size:1rem; color:#fff;">منصة المستقبل</h1>
                    </div>
                </div>
                <!-- Notification Bell -->
                <div
                    style="background:rgba(255,255,255,0.1); width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-bell" style="font-size:1rem; color:#fff;"></i>
                </div>
            </div>

            <script>
                // Enhanced Tab Switching with Back Button Logic
                function switchAppTab(tabName) {
                    // Hide all Views
                    document.getElementById('view-home').style.display = 'none';
                    document.getElementById('view-specs').style.display = 'none';
                    document.getElementById('view-profile').style.display = 'none';
                    document.getElementById('web-content-hidden').style.display = 'none';

                    // Reset Nav Active State
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

                    // Toggle Back Button
                    const backBtn = document.getElementById('app-back-btn');
                    if (tabName === 'home') {
                        document.getElementById('view-home').style.display = 'block';
                        document.querySelector('a[onclick*="home"]').classList.add('active'); // Home Icon
                        backBtn.style.display = 'none'; // Hide on Home
                    } else {
                        backBtn.style.display = 'flex'; // Show on other pages
                    }

                    if (tabName === 'specs') {
                        document.getElementById('web-content-hidden').style.display = 'block';
                        location.hash = "#specs";
                        document.querySelector('a[onclick*="specs"]').classList.add('active');
                    } else if (tabName === 'profile') {
                        document.getElementById('view-profile').style.display = 'block';
                        document.querySelector('a[onclick*="profile"]').classList.add('active');
                    } else if (tabName === 'contact') {
                        document.getElementById('web-content-hidden').style.display = 'block';
                        location.hash = "#contact";
                        document.querySelector('a[onclick*="contact"]').classList.add('active');
                    }
                }
            </script>

            <!-- 2. APP VIEWS CONTAINER -->
            <div id="app-views-container" style="padding: 20px;">

                <!-- VIEW: HOME (Dashboard) -->
                <div id="view-home" class="app-view active-view">

                    <!-- Hero Banner (Vocational Theme) -->
                    <div class="madrasa-card"
                        style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border:none; position:relative; overflow:hidden; padding:25px; min-height:160px; display:flex; flex-direction:column; justify-content:center;">
                        <i class="fa-solid fa-microchip"
                            style="position:absolute; left:-30px; bottom:-30px; font-size:9rem; opacity:0.1; transform:rotate(-20deg);"></i>
                        <div style="position:relative; z-index:2;">
                            <span
                                style="background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:20px; font-size:0.7rem; color:#fff; margin-bottom:10px; display:inline-block;">🎓
                                العام الدراسي 2025-2026</span>
                            <h2 style="font-size:1.5rem; color:#fff; margin:0 0 8px 0; line-height:1.3;">حرفتك.. مستقبلك
                            </h2>
                            <p
                                style="color:rgba(255,255,255,0.9); font-size:0.85rem; margin-bottom:15px; max-width:90%;">
                                تخصص في الأمن السيبراني، تكرير النفط، والأجهزة الطبية.</p>
                            <button
                                onclick="document.getElementById('admission-section').scrollIntoView({behavior:'smooth'})"
                                style="background:#fff; color:#1e3a8a; border:none; padding:10px 24px; border-radius:12px; font-weight:bold; font-size:0.9rem; width:fit-content; box-shadow:0 5px 15px rgba(0,0,0,0.2);">قدّم
                                طلب الانتساب</button>
                        </div>
                    </div>

                    <!-- Main Services (The Grid) -->
                    <h3 style="font-size:1rem; color:#e2e8f0; margin: 25px 0 15px 0; font-weight:600;">الخدمات التعليمية
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">

                        <!-- Student Portal -->
                        <div class="madrasa-card" onclick="requestLogin('student')"
                            style="margin:0; padding:20px; text-align:center; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;">
                            <div class="icon-box-3d" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <i class="fa-solid fa-user-graduate" style="color:#fff;"></i>
                            </div>
                            <span style="color:#f1f5f9; font-weight:bold; font-size:0.9rem; margin-top:10px;">بوابة
                                الطالب</span>
                        </div>

                        <!-- Teacher Portal -->
                        <div class="madrasa-card" onclick="requestLogin('teacher')"
                            style="margin:0; padding:20px; text-align:center; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;">
                            <div class="icon-box-3d" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <i class="fa-solid fa-chalkboard-user" style="color:#fff;"></i>
                            </div>
                            <span
                                style="color:#f1f5f9; font-weight:bold; font-size:0.9rem; margin-top:10px;">الأساتذة</span>
                        </div>

                        <!-- Specialties -->
                        <div class="madrasa-card" onclick="switchAppTab('specs')"
                            style="margin:0; padding:20px; text-align:center; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;">
                            <div class="icon-box-3d" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fa-solid fa-gears" style="color:#fff;"></i>
                            </div>
                            <span
                                style="color:#f1f5f9; font-weight:bold; font-size:0.9rem; margin-top:10px;">التخصصات</span>
                        </div>

                        <!-- Schedule/Contact -->
                        <div class="madrasa-card" onclick="switchAppTab('contact')"
                            style="margin:0; padding:20px; text-align:center; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;">
                            <div class="icon-box-3d" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fa-solid fa-calendar-check" style="color:#fff;"></i>
                            </div>
                            <span style="color:#f1f5f9; font-weight:bold; font-size:0.9rem; margin-top:10px;">الدوام
                                والاتصال</span>
                        </div>
                    </div>

                    <!-- Updates List (School Specific) -->
                    <h3 style="font-size:1rem; color:#e2e8f0; margin: 0 0 15px 0; font-weight:600;">لوحة الإعلانات</h3>
                    <div id="app-news-feed" style="display:flex; flex-direction:column; gap:10px;">
                        <div class="madrasa-card"
                            style="margin:0; padding:15px; display:flex; align-items:center; gap:15px;">
                            <div
                                style="width:40px; height:40px; background:rgba(16, 185, 129, 0.2); border-radius:10px; display:flex; align-items:center; justify-content:center; color:#10b981;">
                                <i class="fa-solid fa-flask"></i>
                            </div>
                            <div>
                                <h4 style="margin:0; font-size:0.9rem; color:#fff;">مختبرات جديدة</h4>
                                <p style="margin:0; font-size:0.75rem; color:#94a3b8;">تجهيز ورشة تكرير النفط بأجهزة
                                    محاكاة حديثة.</p>
                            </div>
                        </div>
                        <div class="madrasa-card"
                            style="margin:0; padding:15px; display:flex; align-items:center; gap:15px;">
                            <div
                                style="width:40px; height:40px; background:rgba(245, 158, 11, 0.2); border-radius:10px; display:flex; align-items:center; justify-content:center; color:#f59e0b;">
                                <i class="fa-solid fa-trophy"></i>
                            </div>
                            <div>
                                <h4 style="margin:0; font-size:0.9rem; color:#fff;">تكريم الأوائل</h4>
                                <p style="margin:0; font-size:0.75rem; color:#94a3b8;">سيتم توزيع الجوائز على أوائل قسم
                                    الأمن السيبراني.</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- VIEW: SPECS (Redirects content) -->
                <div id="view-specs" class="app-view" style="display:none;"></div>

                <!-- VIEW: PROFILE -->
                <div id="view-profile" class="app-view" style="display:none;">
                    <div style="text-align:center; padding-top:50px;">
                        <i class="fa-solid fa-lock" style="font-size:3rem; color:#333; margin-bottom:20px;"></i>
                        <h3>يرجى تسجيل الدخول</h3>
                        <p style="color:#aaa;">قم بتسجيل الدخول للوصول إلى ملفك الشخصي</p>
                        <button onclick="requestLogin('student')" class="btn-glow" style="margin-top:20px;">تسجيل
                            الدخول</button>
                    </div>
                </div>

            </div>

            <!-- Styles for switching -->
            <style>
                .app-view {
                    animation: fadeIn 0.3s ease;
                }

                @keyframes fadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }

                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                /* Hide Original Web Sections Wrapper when in App Mode */
                #web-content-hidden {
                    display: none;
                }
            </style>

            <!-- Script for Tab Switching -->
            <script>
                function switchAppTab(tabName) {
                    // Hide all Views
                    document.getElementById('view-home').style.display = 'none';
                    document.getElementById('view-specs').style.display = 'none';
                    document.getElementById('view-profile').style.display = 'none';
                    document.getElementById('web-content-hidden').style.display = 'none'; // Ensure web content hidden

                    // Reset Nav Active State
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

                    if (tabName === 'home') {
                        document.getElementById('view-home').style.display = 'block';
                        document.querySelector('a[href="#hero"]').classList.add('active'); // Home Icon
                    } else if (tabName === 'specs') {
                        // For specs, we might want to show the original specs section but styled differently
                        // Or just simplistic list. Let's just show the web content for now but filtered?
                        // Actually, better to just show the 'web-content-hidden' but scroll to specs
                        document.getElementById('web-content-hidden').style.display = 'block';
                        location.hash = "#specs";
                        document.querySelector('a[href="#specs"]').classList.add('active');
                    } else if (tabName === 'profile') {
                        document.getElementById('view-profile').style.display = 'block';
                        document.querySelector('a[href="#portals"]').classList.add('active');
                    } else if (tabName === 'contact') {
                        document.getElementById('web-content-hidden').style.display = 'block';
                        location.hash = "#contact";
                        document.querySelector('a[href="#contact"]').classList.add('active');
                    }
                }
            </script>

            <!-- Wrap Original Content to Hide it -->
            <div id="web-content-hidden">
                <!-- Hero Section (Modified for App) -->
                <!-- Boot Screen -->
                <div id="boot-screen">
                    <div id="boot-log-container"></div>
                    <div class="boot-progress">
                        <div class="boot-bar" id="boot-bar"></div>
                    </div>
                </div>



                <!-- Canvas BG -->
                <div id="canvas-container"><canvas id="bgCanvas"></canvas></div>
                <!-- Cursor Glow -->
                <div class="cursor-glow" id="cursorGlow"></div>

                <!-- ISOLATED APPLY BUTTON -->
                <a href="#admission-section"
                    style="position: fixed; top: 120px; left: 30px; z-index: 2000; cursor: pointer; text-decoration: none;">
                    <div class="glass-panel"
                        style="padding: 15px 25px; border: 1px solid var(--secondary); display: flex; align-items: center; gap: 15px; transition: 0.3s; background: rgba(0,0,0,0.9); box-shadow: 0 0 20px rgba(0,255,255,0.2); transform: scale(1.1); filter: drop-shadow(0 0 5px var(--secondary));">
                        <i class="fa-solid fa-file-signature"
                            style="color: var(--secondary); font-size: 2rem; animation: pulse 2s infinite;"></i>
                        <div style="text-align: right;">
                            <span style="display: block; color: #fff; font-weight: bold; font-size: 1rem;">تقديم طلب
                                انتساب</span>
                            <span style="display: block; color: #aaa; font-size: 0.7rem;">للعام الدراسي
                                الجديد</span>
                        </div>
                    </div>
                </a>

                <!-- Navigation -->
                <nav>
                    <div class="logo">
                        <img src="logo.jpg" alt="شعار المدرسة">
                    </div>
                    <div class="nav-items">
                        <a href="#hero" class="nav-link">الرئيسية</a>
                        <a href="#about" class="nav-link">عن المدرسة</a>
                        <a href="#specs" class="nav-link">التخصصات</a>
                        <a href="#facilities" class="nav-link">المرافق</a>
                        <a href="#contact" class="nav-link">تواصل معنا</a>
                    </div>
                    <a href="#portals" class="btn-glow">تسجيل الدخول للنظام</a>
                </nav>

                <!-- Hero Section -->
                <section class="hero" id="hero" style="position: relative;">
                    <div class="container"
                        style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; height: 100%; gap: 100px;">

                        <!-- Content (Right) -->
                        <div class="hero-content" style="text-align: right; max-width: 600px; padding-top: 50px;">
                            <div class="floating-badge">🎓 عام دراسي 2025-2026</div>
                            <h1 class="glitch-text" style="font-size: 3.5rem;" data-text="اعدادية النهرين المهنية">
                                اعدادية
                                النهرين
                                المهنية<br><span style="color: var(--primary);">حيث يُصنع المستقبل</span></h1>
                            <p style="font-size: 1.2rem;">11 تخصصاً مهنياً متطوراً يجمع بين العلم والتطبيق لبناء جيل
                                من
                                القادة
                                المهنيين</p>
                            <div style="display: flex; gap: 20px; justify-content: flex-start;">
                                <a href="#specs" class="btn-glow"
                                    style="background: transparent; border: 1px solid var(--primary);">استكشف
                                    التخصصات</a>
                            </div>
                        </div>

                        <!-- Login Side (Left) -->
                        <div class="auth-box"
                            style="margin-top: 50px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); width: 350px;">
                            <h2 style="font-size: 1.5rem;"><i class="fa-solid fa-laptop-code"></i> المنصة
                                الإلكترونية</h2>
                            <p style="color:#ccc; margin-bottom: 20px; font-size: 0.9rem;">سجّل دخولك للوصول للخدمات
                            </p>

                            <div class="auth-card" style="text-align: center;">
                                <i class="fa-solid fa-school-flag"
                                    style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                                <h3 style="margin-bottom: 20px;">بوابة المدرسة الذكية</h3>
                                <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">سجل دخولك أو أنشئ
                                    حساباً جديداً
                                    للوصول
                                    للخدمات</p>

                                <button class="btn-glow" onclick="requestLogin('student')" style="width: 100%;">تسجيل
                                    الدخول
                                    / إنشاء
                                    حساب</button>
                            </div>

                        </div>

                    </div>
                </section>

                <!-- Stats Section -->
                <section class="container" style="margin-bottom: 80px;">
                    <div class="stats-grid">
                        <div class="stat-card"><span class="stat-number" data-target="2025">0</span><span>سنة
                                التأسيس</span>
                        </div>
                        <div class="stat-card"><span class="stat-number" data-target="650"
                                data-prefix="+">0</span><span>طالب
                                وطالبة</span></div>
                        <div class="stat-card"><span class="stat-number" data-target="11">0</span><span>تخصص
                                مهني</span>
                        </div>
                        <div class="stat-card"><span class="stat-number" data-target="30"
                                data-prefix="+">0</span><span>كادر
                                تدريسي</span></div>
                    </div>
                </section>

                <!-- Vision Section -->
                <section class="container" id="about">
                    <div class="section-title">
                        <h2>رؤيتنا ورسالتنا</h2>
                        <p>نسعى لتقديم تعليم مهني استثنائي يواكب التطور العالمي</p>
                    </div>
                    <div class="vision-grid">
                        <div class="vision-card">
                            <i class="fa-solid fa-eye card-icon"></i>
                            <h3>رؤيتنا</h3>
                            <p style="color: #ccc; line-height: 1.8; margin-top: 15px;">أن نكون المؤسسة التعليمية
                                المهنية
                                الرائدة،
                                ونموذجاً يحتذى به في التعليم المهني المتميز الذي يواكب أحدث المعايير العالمية ويلبي
                                متطلبات
                                سوق
                                العمل.</p>
                        </div>
                        <div class="vision-card">
                            <i class="fa-solid fa-bullseye card-icon"></i>
                            <h3>رسالتنا</h3>
                            <p style="color: #ccc; line-height: 1.8; margin-top: 15px;">تقديم تعليم مهني شامل ومتطور
                                يجمع
                                بين
                                المعرفة النظرية الرصينة والمهارات العملية المتقدمة لإعداد كوادر متميزة قادرة على
                                الإبداع.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Specializations -->
                <section class="container" id="specs">
                    <div class="section-title">
                        <h2>التخصصات المتاحة</h2>
                        <p>اختر التخصص الذي يناسب شغفك ويحقق طموحاتك</p>
                    </div>
                    <div class="cards-grid-small">
                        <div class="spec-card">
                            <div class="spec-icon">🤖</div>
                            <h4>الذكاء الاصطناعي</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">🔒</div>
                            <h4>الأمن السيبراني</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">🏥</div>
                            <h4>الأجهزة الطبية</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">⛽</div>
                            <h4>تكرير النفط والغاز</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">🏗️</div>
                            <h4>البناء والإنشاءات</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">💼</div>
                            <h4>المحاسبة</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">🏦</div>
                            <h4>العلوم المصرفية</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">📊</div>
                            <h4>الإدارة</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">🎨</div>
                            <h4>الفنون التطبيقية</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">💻</div>
                            <h4>صيانة الحاسبات</h4>
                        </div>
                        <div class="spec-card">
                            <div class="spec-icon">⚽</div>
                            <h4>الرياضة</h4>
                        </div>
                    </div>
                </section>

                <!-- Facilities -->
                <section class="container" id="facilities">
                    <div class="section-title">
                        <h2>مرافقنا المتطورة</h2>
                    </div>
                    <div class="vision-grid">
                        <div class="vision-card" style="border-right-color: var(--primary);">
                            <i class="fa-solid fa-flask card-icon"></i>
                            <h3>مختبرات علمية</h3>
                            <p>مجهزة بأحدث الأجهزة والمعدات العلمية للتجارب العملية المتقدمة.</p>
                        </div>
                        <div class="vision-card" style="border-right-color: var(--primary);">
                            <i class="fa-solid fa-server card-icon"></i>
                            <h3>قاعات حاسوب</h3>
                            <p>مزودة بإنترنت عالي السرعة وبرامج المحاكاة الحديثة.</p>
                        </div>
                        <div class="vision-card" style="border-right-color: var(--primary);">
                            <i class="fa-solid fa-book card-icon"></i>
                            <h3>مكتبة شاملة</h3>
                            <p>تضم آلاف المراجع العلمية والكتب التخصصية الورقية والإلكترونية.</p>
                        </div>
                        <div class="vision-card" style="border-right-color: var(--primary);">
                            <i class="fa-solid fa-futbol card-icon"></i>
                            <h3>ملاعب رياضية</h3>
                            <p>ساحات وملاعب مجهزة لممارسة مختلف الأنشطة الرياضية والبطولات.</p>
                        </div>
                    </div>
                </section>

                <!-- GALLERY SECTION -->
                <section id="gallery" style="padding: 100px 20px; background: #000; text-align: center;">
                    <h2 class="section-title"><i class="fa-solid fa-images"></i> معرض الصور</h2>
                    <p style="color:#aaa; max-width:600px; margin:0 auto 40px auto;">جانب من مرافقنا التعليمية
                        المتطورة
                        ونشاطات
                        طلبتنا المتميزين.</p>
                    <div class="container"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                        <!-- Image 1 -->
                        <div class="glass-panel"
                            style="padding: 10px; background: #050505; transition: transform 0.3s; cursor:pointer;"
                            onclick="viewGalleryImage(1)">
                            <div style="height: 250px; background: #111; overflow: hidden; border-radius: 5px;">
                                <img id="gallery-img-1" src="g1.jpg"
                                    style="width:100%; height:100%; object-fit:cover; transition: transform 0.5s;"
                                    onmouseover="this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.transform='scale(1)'">
                            </div>
                            <h4 id="gallery-title-1" style="margin-top: 15px; color: var(--primary);">ساحة التجمع
                                الصباحي
                            </h4>
                        </div>
                        <!-- Image 2 -->
                        <div class="glass-panel"
                            style="padding: 10px; background: #050505; transition: transform 0.3s; cursor:pointer;"
                            onclick="viewGalleryImage(2)">
                            <div style="height: 250px; background: #111; overflow: hidden; border-radius: 5px;">
                                <img id="gallery-img-2" src="g2.jpg"
                                    style="width:100%; height:100%; object-fit:cover; transition: transform 0.5s;"
                                    onmouseover="this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.transform='scale(1)'">
                            </div>
                            <h4 id="gallery-title-2" style="margin-top: 15px; color: var(--primary);">القاعات
                                الدراسية
                                الذكية</h4>
                        </div>
                        <!-- Image 3 -->
                        <div class="glass-panel"
                            style="padding: 10px; background: #050505; transition: transform 0.3s; cursor:pointer;"
                            onclick="viewGalleryImage(3)">
                            <div style="height: 250px; background: #111; overflow: hidden; border-radius: 5px;">
                                <img id="gallery-img-3" src="g3.jpg"
                                    style="width:100%; height:100%; object-fit:cover; transition: transform 0.5s;"
                                    onmouseover="this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.transform='scale(1)'">
                            </div>
                            <h4 id="gallery-title-3" style="margin-top: 15px; color: var(--primary);">الأنشطة
                                المدرسية</h4>
                        </div>
                    </div>
                </section>

                <!-- PARTNERSHIP SECTION (Strategic Placement: Below Gallery) -->
                <section id="partnership"
                    style="padding: 60px 20px; position: relative; z-index: 2; background: linear-gradient(180deg, #000 0%, #050505 100%);">
                    <div class="container">
                        <div class="glass-panel"
                            style="display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 40px; padding: 50px; border: 1px solid rgba(255, 255, 255, 0.1); background: linear-gradient(145deg, rgba(20, 20, 30, 0.8) 0%, rgba(0,0,0,0.9) 100%); box-shadow: 0 0 40px rgba(0, 242, 255, 0.05);">

                            <!-- Text Content -->
                            <div style="flex: 1; min-width: 300px; text-align: right;">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                    <span style="font-size: 2.5rem; text-shadow: 0 0 10px gold;">🤝</span>
                                    <h2 class="section-title" style="margin: 0; font-size: 2rem; text-align: right;">
                                        شركاء
                                        مسيرة
                                        النجاح</h2>
                                </div>
                                <h3 style="color: #fff; font-size: 1.5rem; margin-bottom: 20px; line-height: 1.6;">
                                    إعدادية النهرين المهنية <span
                                        style="color: var(--primary); font-size:2rem; vertical-align:middle;">×</span>
                                    الشركة
                                    اللبنانية الدولية
                                </h3>
                                <p style="color: #ccc; font-size: 1.1rem; line-height: 1.9; margin-bottom: 30px;">
                                    مشروع تعليمي رائد انبثق من رؤية مشتركة تجمع بين <strong style="color: #fff;">الأصالة
                                        العراقية</strong> و <strong style="color: #fff;">الخبرة الدولية</strong>.
                                    تعاوننا مع الشركة اللبنانية الدولية للإدارة والتطوير يهدف لبناء جيل مهني مسلح
                                    بأحدث
                                    المهارات
                                    العالمية.
                                </p>
                                <div style="display: flex; gap: 15px; flex-wrap:wrap;">
                                    <div
                                        style="background: rgba(206, 17, 38, 0.15); border: 1px solid #ce1126; padding: 8px 20px; border-radius: 30px; color: #fff; font-size: 1rem; display:flex; align-items:center; gap:8px;">
                                        <img src="https://flagcdn.com/w40/lb.png" style="width:20px;"> خبرة دولية
                                        عريقة
                                    </div>
                                    <div
                                        style="background: rgba(0, 255, 0, 0.1); border: 1px solid #00ce29; padding: 8px 20px; border-radius: 30px; color: #fff; font-size: 1rem; display:flex; align-items:center; gap:8px;">
                                        <img src="https://flagcdn.com/w40/iq.png" style="width:20px;"> صرح علمي وطني
                                    </div>
                                </div>
                            </div>

                            <!-- Image/Banner -->
                            <div style="flex: 1; min-width: 300px; display: flex; justify-content: center;">
                                <div class="hover-glow"
                                    style="position: relative; overflow: hidden; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.6); transform: perspective(1000px) rotateY(-5deg); transition: transform 0.5s;">
                                    <img src="partner.jpg" alt="Partnership Logo"
                                        style="width: 100%; max-width: 550px; display: block;">
                                    <div
                                        style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); pointer-events: none;">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>

                <!-- Portals Section -->
                <!-- Portals Section -->
                <section id="portals"
                    style="margin-top: 150px; padding: 100px 0; background: linear-gradient(to bottom, transparent, #050505);">
                    <div class="container">
                        <div class="section-title">
                            <h2>النظام الإلكتروني</h2>
                            <p>بوابات الدخول للطلاب والكوادر التدريسية</p>
                        </div>
                        <div class="portal-grid">
                            <div class="portal-card" onclick="requestLogin('student')">
                                <i class="fa-solid fa-graduation-cap"
                                    style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                                <h3>بوابة الطالب</h3>
                                <p style="color: #aaa;">عرض الدرجات والجدول</p>
                            </div>
                            <div class="portal-card" onclick="requestLogin('teacher')">
                                <i class="fa-solid fa-chalkboard-user"
                                    style="font-size: 3rem; color: var(--secondary); margin-bottom: 15px;"></i>
                                <h3>بوابة التدريسيين</h3>
                                <p style="color: #aaa;">إدارة الدرجات والحضور</p>
                            </div>
                            <!-- ADDED: Gallery Management -->
                            <!-- Moved to Admin Dashboard -->
                            <div class="portal-card" onclick="requestLogin('admin')">
                                <i class="fa-solid fa-user-tie"
                                    style="font-size: 3rem; color: #fff; margin-bottom: 15px;"></i>
                                <h3>الإدارة المدرسية</h3>
                                <p style="color: #aaa;">شؤون الطلبة والموظفين</p>
                            </div>
                            <div class="portal-card" onclick="requestLogin('admin')">
                                <i class="fa-solid fa-server"
                                    style="font-size: 3rem; color: #0f0; margin-bottom: 15px;"></i>
                                <h3>IT & NFC System</h3>
                                <p style="color: #aaa;">التحكم التقني والبوابات</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Contact -->
                <section class="container" id="contact" style="padding-bottom: 100px;">
                    <div class="section-title">
                        <h2>تواصل معنا</h2>
                    </div>
                    <div class="vision-grid">
                        <div class="vision-card" style="text-align: center;">
                            <i class="fa-solid fa-location-dot card-icon"></i>
                            <h3>العنوان</h3>
                            <p>المثنى - السماوة - شارع المحافظة</p>
                        </div>
                        <div class="vision-card" style="text-align: center;">
                            <i class="fa-solid fa-phone card-icon"></i>
                            <h3>الهاتف</h3>
                            <p style="font-size: 1.5rem; color: var(--primary); direction: ltr;">0787 077 7892</p>
                        </div>
                        <div class="vision-card" style="text-align: center;">
                            <i class="fa-solid fa-clock card-icon"></i>
                            <h3>أوقات الدوام</h3>
                            <p>الأحد - الخميس: 2:15 م - 6:15 م</p>
                        </div>
                    </div>
                </section>

                <!-- TOP STUDENTS SECTION -->
                <section id="top-students" style="padding: 80px 20px; background: #050505; text-align: center;">
                    <h2 class="section-title" style="margin-bottom: 50px;"><i class="fa-solid fa-medal"></i> لوحة
                        الشرف -
                        أوائل
                        الطلبة</h2>
                    <div class="container"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
                        <!-- Student 1 -->
                        <div class="glass-panel"
                            style="padding: 30px; border-top: 3px solid gold; transition: transform 0.3s; box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);">
                            <div style="font-size: 3rem; color: gold; margin-bottom: 20px;"><i
                                    class="fa-solid fa-crown"></i></div>
                            <h3 id="h1-name" style="color: #fff; font-size: 1.5rem; margin-bottom: 10px;">أحمد مهند
                            </h3>
                            <p id="h1-major" style="color: var(--primary); font-size: 1.1rem;">الأول - الأمن
                                السيبراني</p>
                            <p id="h1-grade" style="color: #aaa; font-size: 0.9rem;">المعدل: 98.5%</p>
                        </div>
                        <!-- Student 2 -->
                        <div class="glass-panel"
                            style="padding: 30px; border-top: 3px solid silver; transition: transform 0.3s; box-shadow: 0 0 20px rgba(192, 192, 192, 0.1);">
                            <div style="font-size: 3rem; color: silver; margin-bottom: 20px;"><i
                                    class="fa-solid fa-award"></i>
                            </div>
                            <h3 id="h2-name" style="color: #fff; font-size: 1.5rem; margin-bottom: 10px;">سارة علي
                            </h3>
                            <p id="h2-major" style="color: var(--primary); font-size: 1.1rem;">الأولى - الأجهزة
                                الطبية</p>
                            <p id="h2-grade" style="color: #aaa; font-size: 0.9rem;">المعدل: 97.2%</p>
                        </div>
                        <!-- Student 3 -->
                        <div class="glass-panel"
                            style="padding: 30px; border-top: 3px solid #cd7f32; transition: transform 0.3s; box-shadow: 0 0 20px rgba(205, 127, 50, 0.1);">
                            <div style="font-size: 3rem; color: #cd7f32; margin-bottom: 20px;"><i
                                    class="fa-solid fa-star"></i>
                            </div>
                            <h3 id="h3-name" style="color: #fff; font-size: 1.5rem; margin-bottom: 10px;">محمد قاسم
                            </h3>
                            <p id="h3-major" style="color: var(--primary); font-size: 1.1rem;">الأول - تكرير النفط
                            </p>
                            <p id="h3-grade" style="color: #aaa; font-size: 0.9rem;">المعدل: 96.8%</p>
                        </div>
                    </div>
                </section>



                <!-- ADMISSION SECTION -->
                <section id="admission-section"
                    style="padding: 80px 20px; background: linear-gradient(to top, #000, #0a0a0a); position: relative; z-index: 10; scroll-margin-top: 50px;">
                    <div class="container" style="max-width: 800px; margin: 0 auto;">
                        <div class="glass-panel"
                            style="padding: 50px; border: 1px solid var(--primary); box-shadow: 0 0 40px rgba(0,255,255,0.05);">
                            <h1
                                style="color: var(--primary); margin-bottom: 10px; font-size: 2.2rem; text-align: center;">
                                <i class="fa-solid fa-file-contract"></i> استمارة القبول الإلكتروني
                            </h1>
                            <p style="color:#aaa; text-align: center; margin-bottom: 50px; font-size: 1.1rem;">سجل
                                بياناتك
                                الآن
                                للانضمام إلى نخبة المستقبل للعام الدراسي القادم</p>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; text-align: right;">
                                <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">الاسم
                                        الكامل</label><input type="text" id="app-name" class="cyber-input"
                                        placeholder="الاسم الرباعي واللقب" style="width:100%"></div>
                                <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">المدرسة
                                        السابقة</label><input type="text" id="app-school" class="cyber-input"
                                        placeholder="اسم المدرسة" style="width:100%"></div>
                            </div>
                            <div style="margin-top: 25px; text-align: right;">
                                <label style="color: var(--secondary); display:block; margin-bottom:8px;">القسم
                                    المطلوب</label>
                                <select id="app-major" class="cyber-input"
                                    style="width:100%; color:#fff; background:#111;">
                                    <option value="">-- اختر القسم الراغب به --</option>
                                    <option value="الأمن السيبراني">الأمن السيبراني</option>
                                    <option value="تكرير النفط والغاز">تكرير النفط والغاز</option>
                                    <option value="الأجهزة الطبية">الأجهزة الطبية</option>
                                    <option value="تكنولوجيا الطيـران">تكنولوجيا الطيران</option>
                                    <option value="الإلكترونيك والسيطرة">الإلكترونيك والسيطرة</option>
                                    <option value="أخرى">تخصص آخر</option>
                                </select>
                            </div>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px; text-align: right;">
                                <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">المعدل /
                                        المجموع</label><input type="number" id="app-avg" class="cyber-input"
                                        placeholder="00.0" style="width:100%"></div>
                                <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">رقم
                                        الهاتف</label><input type="tel" id="app-phone" class="cyber-input"
                                        placeholder="07xxxxxxxxx" style="width:100%"></div>
                            </div>
                            <button class="btn-glow" onclick="submitApplication()"
                                style="width:100%; margin-top:40px; font-size:1.2rem; padding: 15px;">إرسال الطلب
                                نهائياً
                                🚀</button>
                        </div>
                    </div>
                </section>

                <footer
                    style="text-align: center; padding: 40px; background: rgba(0,0,0,0.8); color: #888; border-top: 1px solid #333;">
                    <p>&copy; 2025 اعدادية النهرين المهنية - جميع الحقوق محفوظة</p>
                </footer>

                <!-- News Ticker -->
                <div class="news-ticker">
                    <div class="ticker-label">عاجل</div>
                    <div class="ticker-wrap">
                        <div class="ticker-content" id="dynamic-ticker-content">
                            <div class="ticker-item"><i class="fa-solid fa-bullhorn"></i> هام: افتتاح التسجيل
                                للدورات
                                الصيفية
                                المجانية في البرمجة</div>
                            <div class="ticker-item"><i class="fa-solid fa-trophy"></i> تكريم الطلبة الأوائل على
                                مستوى
                                المحافظة يوم
                                الخميس القادم</div>
                            <div class="ticker-item"><i class="fa-solid fa-calendar"></i> ورشة عمل حول الذكاء
                                الاصطناعي (AI)
                                مفتوحة
                                للجميع يوم السبت</div>
                            <div class="ticker-item"><i class="fa-solid fa-flask"></i> تم تجهيز مختبرات تكرير النفط
                                بأجهزة
                                محاكاة
                                حديثة</div>
                        </div>
                    </div>
                </div>




                <!-- Registration Overlay (Existing) -->
                <!-- Auth Overlay (Login) -->
                <div id="auth-overlay" class="dashboard-overlay" style="z-index: 3000;">
                    <div class="auth-box">
                        <h2 style="color: var(--primary); margin-bottom: 20px;">تسجيل الدخول</h2>
                        <p id="modal-error" style="color: red; display: none; margin-bottom: 15px;"></p>
                        <input type="email" id="modal-email" class="cyber-input" placeholder="البريد الإلكتروني">
                        <input type="password" id="modal-pass" class="cyber-input" placeholder="كلمة المرور">
                        <button class="btn-glow" id="login-btn" onclick="validateLogin()">دخول</button>

                        <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                            <p style="color: #aaa; font-size: 0.9rem;">ليس لديك حساب؟</p>
                            <button class="btn-glow"
                                style="background: transparent; border: 1px solid var(--secondary); color: var(--secondary); margin-top: 10px; font-size: 0.9rem;"
                                onclick="document.getElementById('auth-overlay').style.display='none'; showRegistration();">
                                إنشاء حساب جديد (طالب / كادر)
                            </button>
                        </div>

                        <p style="margin-top: 20px; cursor: pointer; color: #aaa;"
                            onclick="document.getElementById('auth-overlay').style.display='none'">إلغاء</p>
                    </div>
                </div>
                <div id="reg-overlay" class="dashboard-overlay"
                    style="z-index: 20000; text-align: center; display: none;">
                    <div class="auth-box"
                        style="margin: 2% auto; width: 500px; position: relative; max-height: 90vh; overflow-y: auto;">
                        <i class="fa-solid fa-xmark" onclick="closeReg()"
                            style="position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; color: #fff;"></i>

                        <div
                            style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px; padding-top:10px;">
                            <button id="btn-mode-student" class="btn-glow"
                                style="flex:1; margin-left:5px; background:var(--primary); color:#000;"
                                onclick="setRegMode('student')">طالب</button>
                            <button id="btn-mode-staff" class="btn-glow"
                                style="flex:1; margin-right:5px; background:transparent; border:1px solid #555;"
                                onclick="setRegMode('staff')">كادر تدريسي/إداري</button>
                        </div>

                        <h2 id="reg-title" style="color: var(--secondary); margin-bottom: 20px;">📝 إنشاء حساب طالب
                            جديد
                        </h2>
                        <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">سيتم ربط حسابك بالنظام السحابي
                            للمدرسة
                        </p>

                        <input type="text" id="reg-name" class="cyber-input" placeholder="الاسم الكامل">
                        <input type="tel" id="reg-phone" class="cyber-input" placeholder="رقم الهاتف (للتواصل واتساب)">
                        <input type="email" id="reg-email" class="cyber-input" placeholder="البريد الإلكتروني (Email)">
                        <input type="password" id="reg-pass" class="cyber-input"
                            placeholder="كلمة المرور (لاتقل عن 6 رموز)">

                        <!-- Student Options -->
                        <div id="reg-student-opts">
                            <select id="reg-class" class="cyber-input">
                                <option value="">اختر الشعبة / التخصص...</option>
                                <option value="cyber-science">الأمن السيبراني - علوم</option>
                                <option value="cyber-lab">الأمن السيبراني - قاعة الحاسوب</option>
                                <option value="cyber-2c">الأمن السيبراني - 2C</option>
                                <option value="cyber-2a">الأمن السيبراني - 2A</option>
                                <option value="cyber-g6">الأمن السيبراني - G6</option>
                                <option value="oil-gas">تكرير النفط</option>
                                <option value="med-inst">الأجهزة الطبية</option>
                            </select>
                        </div>

                        <!-- Staff Options -->
                        <div id="reg-staff-opts" style="display:none;">
                            <select id="reg-role" class="cyber-input">
                                <option value="teacher">مدرس / أستاذ</option>
                                <option value="admin">إدارة / IT</option>
                            </select>
                            <input type="password" id="reg-secret" class="cyber-input"
                                placeholder="رمز الأمان الخاص بالمدرسة" style="border-color:red;">
                        </div>

                        <button class="btn-glow" onclick="processRegistration()">إنشاء الحساب 🚀</button>
                        <p id="reg-status" style="margin-top:10px; color:#aaa; font-size:0.9rem;"></p>

                        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                            <p style="color: #aaa; cursor: pointer; font-size: 0.9rem;"
                                onclick="closeReg(); document.getElementById('auth-overlay').style.display='flex';">
                                لديك حساب بالفعل؟ <span style="color: var(--primary); font-weight: bold;">تسجيل
                                    الدخول</span>
                            </p>
                            <p style="color:red; margin-top:10px; cursor:pointer;" onclick="closeReg()">إغلاق
                                النافذة</p>
                        </div>
                    </div>
                </div>

                <!-- ================== DASH BOARDS ================== -->
                <!-- Student -->
                <div id="student-dash" class="dashboard-overlay">
                    <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
                    <div class="container" style="max-width: 1000px; margin-top: 50px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                            <h1><i class="fa-solid fa-user-graduate"></i> مرحباً، علي محمد</h1>
                            <div class="floating-badge">الصف الثالث - أمن سيبراني</div>
                        </div>
                        <div class="glass-panel" style="padding: 30px;">
                            <!-- Financials -->
                            <div
                                style="background: rgba(255,50,50,0.1); border: 1px solid red; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="color: #ff5555; margin-bottom: 10px;"><i
                                        class="fa-solid fa-money-bill-wave"></i>
                                    الأقساط
                                    الدراسية</h3>
                                <table class="cyber-table" style="margin-top: 0;">
                                    <thead>
                                        <tr>
                                            <th>القسط (الشهر)</th>
                                            <th>المبلغ</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="student-installments-body"></tbody>
                                </table>
                            </div>

                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3><i class="fa-solid fa-star"></i> كشف الدرجات</h3>
                                <button class="btn-glow" onclick="window.print()"
                                    style="padding:5px 15px; font-size:0.9rem;"><i class="fa-solid fa-print"></i>
                                    طباعة
                                    النتيجة</button>
                            </div>
                            <table class="cyber-table">
                                <thead>
                                    <tr>
                                        <th>المادة</th>
                                        <th>الدرجة</th>
                                        <th>التقدير</th>
                                    </tr>
                                </thead>
                                <tbody id="student-grades-body"></tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Teacher -->
            <div id="teacher-dash" class="dashboard-overlay">
                <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
                <div class="container" style="max-width: 900px; margin-top: 50px;">
                    <h1 style="margin-bottom: 40px;"><i class="fa-solid fa-chalkboard-user"></i> لوحة الأساتذة</h1>
                    <h3 id="teacher-welcome" style="color: var(--primary); margin-bottom: 20px;"></h3>

                    <div class="glass-panel" style="padding: 40px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>إدخال الدرجات (النظام التفصيلي)</h3>
                            <span id="permission-badge" class="grade-badge" style="border: 1px solid #aaa;">--</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; margin: 20px 0 10px; color: #aaa;">القسم /
                                    الشعبة</label>
                                <select id="teacher-class-select" class="cyber-input" onchange="loadClassStudents()"
                                    style="background:#111; color:#fff;">
                                    <option value="">اختر الشعبة...</option>
                                    <option value="cyber-science">الأمن السيبراني - علوم</option>
                                    <option value="cyber-lab">الأمن السيبراني - قاعة الحاسوب</option>
                                    <option value="cyber-2c">الأمن السيبراني - 2C</option>
                                    <option value="cyber-2a">الأمن السيبراني - 2A</option>
                                    <option value="cyber-g6">الأمن السيبراني - G6</option>
                                    <option value="oil-gas">تكرير النفط</option>
                                    <option value="med-inst">الأجهزة الطبية</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin: 20px 0 10px; color: #aaa;">المادة
                                    الدراسية</label>
                                <select id="teacher-subject-select" class="cyber-input"
                                    onchange="checkSubjectPermission()" style="background:#111; color:#fff;">
                                    <option value="">(اختر الشعبة أولاً)</option>
                                </select>
                            </div>
                        </div>

                        <div id="grade-actions" style="margin-top: 30px; text-align: center; display:none;">
                            <p style="color:#aaa; margin-bottom:15px;">هل تريد رصد الدرجات التفصيلية؟ (يومي، شهري،
                                نهائي)
                            </p>
                            <a href="javascript:void(0)" class="btn-glow" id="open-gb-btn"
                                style="display:inline-block; text-decoration:none; color:white; width:100%; padding:20px; font-size:1.2rem; background: linear-gradient(45deg, #00d2ff, #3a7bd5); position:relative; z-index:999999;"
                                onclick="openGradebook()">
                                <i class="fa-solid fa-table"></i> فتح سجل الدرجات الكامل
                            </a>
                        </div>

                        <!-- Hidden inputs for legacy/fallback (kept to avoid JS errors if references exist) -->
                        <div style="display:none;">
                            <select id="teacher-student-select"></select>
                            <input id="grade-input">
                            <button id="grade-submit-btn"></button>
                        </div>
                    </div>


                    <!-- Quick List View -->
                    <div id="class-list-preview"
                        style="margin-top: 30px; max-height: 300px; overflow-y: auto; display: none;">
                        <h4 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">قائمة
                            الطلاب
                        </h4>
                        <table class="cyber-table" style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>ت</th>
                                    <th>الاسم الثلاثي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dash" class="dashboard-overlay">
            <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
            <div class="container" style="max-width: 800px; margin-top: 50px;">
                <div class="glass-panel" style="text-align: center; margin-bottom: 20px;">
                    <i class="fa-solid fa-graduation-cap"
                        style="font-size: 3rem; color: var(--primary); margin-bottom:10px;"></i>
                    <h2 id="std-welcome-name" style="color:#fff;">أهلاً بك</h2>
                    <p id="std-welcome-major" style="color:var(--secondary);">الطالب المثابر</p>
                </div>

                <div class="glass-panel" style="margin-bottom: 20px;">
                    <h3><i class="fa-solid fa-star"></i> سجل الدرجات (مباشر من السحابة)</h3>
                    <table class="cyber-table">
                        <thead>
                            <tr>
                                <th>المادة</th>
                                <th>الدرجة</th>
                                <th>التقدير</th>
                            </tr>
                        </thead>
                        <tbody id="std-grades-body">
                            <tr>
                                <td colspan="3" style="color:#aaa;">جاري جلب البيانات...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <button class="btn-glow" style="width:100%; background:rgba(255,0,0,0.2); border-color:red;"
                    onclick="closeDashboards();">تسجيل الخروج</button>
            </div>
        </div>

        <!-- Admin (NFC) -->
        <div id="admin-dash" class="dashboard-overlay">
            <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
            <div class="container" style="max-width: 1000px; margin-top: 50px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h1><i class="fa-solid fa-user-shield"></i> لوحة الإدارة المتقدمة</h1>
                    <div class="tabs">
                        <button class="btn-glow" onclick="showAdminTab('stats')">📊 الإحصائيات</button>
                        <button class="btn-glow" onclick="showAdminTab('staff')">الكادر</button>
                        <button class="btn-glow" onclick="showAdminTab('students')">الطلاب</button>
                        <button class="btn-glow" onclick="showAdminTab('apps')">الطلبات</button>
                        <button class="btn-glow" onclick="showAdminTab('gallery-admin')">🖼️ المعرض</button>
                        <button class="btn-glow" onclick="showAdminTab('honor-admin')">🏅 الأوائل</button>
                        <button class="btn-glow" onclick="showAdminTab('finance')">💰 الحسابات</button>
                        <button class="btn-glow" onclick="showAdminTab('nfc')">NFC</button>
                    </div>
                </div>


                <!-- TAB: STAFF (RE-ADDED & CLEANED) -->
                <div id="tab-staff" class="admin-tab" style="display:none;">
                    <div class="glass-panel">
                        <h3>👨‍🏫 إدارة الكادر التدريسي</h3>
                        <p style="color:#aaa;">إضافة وتعديل صلاحيات الأساتذة والمواد التي يدرسونها.</p>

                        <!-- NEW CLEAN FORM injected by renderAdminLists -->
                        <div id="admin-staff-list" style="margin-top:20px;">
                            <!-- JS will populate: Input Row + Table -->
                        </div>
                    </div>
                </div>

                <!-- TAB: FINANCE (NEW) -->
                <div id="tab-finance" class="admin-tab" style="display:none;">
                    <div class="glass-panel">
                        <h3>💰 إدارة الأقساط المدرسية</h3>
                        <p style="color:#aaa;">متابعة تسديد الأقساط وإرسال تذكيرات عبر الواتساب للمتأخرين.</p>

                        <!-- Add New Debt -->
                        <div
                            style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
                            <input id="fin-name" class="cyber-input" placeholder="اسم الطالب" style="flex:1;">
                            <input id="fin-phone" class="cyber-input" placeholder="رقم الهاتف (مثال: 077...)"
                                style="flex:1;">
                            <input id="fin-amount" class="cyber-input" placeholder="المبلغ المستحق (د.ع)"
                                style="width:150px;">
                            <input id="fin-date" type="date" class="cyber-input">
                            <button class="btn-glow" onclick="addFinanceRecord()">➕ إضافه قسط</button>
                        </div>

                        <!-- Filter Buttons -->
                        <div style="margin-bottom:15px;">
                            <button class="btn-glow" style="background:transparent; border:1px solid #555;"
                                onclick="renderFinanceTable('all')">الكل</button>
                            <button class="btn-glow" style="background:transparent; border:1px solid red; color:red;"
                                onclick="renderFinanceTable('late')">🔴 المتأخرين فقط</button>
                        </div>

                        <!-- Table -->
                        <div style="overflow-x:auto;">
                            <table class="data-table" style="width:100%; text-align:right;">
                                <thead>
                                    <tr style="background:rgba(0,255,255,0.1);">
                                        <th>الطالب</th>
                                        <th>المبلغ</th>
                                        <th>تاريخ الاستحقاق</th>
                                        <th>الحالة</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="finance-table-body">
                                    <!-- Data loads here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <script>
                    // Finance Logic
                    function getFinanceDB() { return JSON.parse(localStorage.getItem('school_finance_db')) || []; }
                    function saveFinanceDB(data) { localStorage.setItem('school_finance_db', JSON.stringify(data)); }

                    function addFinanceRecord() {
                        const name = document.getElementById('fin-name').value;
                        const phone = document.getElementById('fin-phone').value;
                        const amount = document.getElementById('fin-amount').value;
                        const date = document.getElementById('fin-date').value;

                        if (!name || !amount || !date) return alert("يرجى إدخال كافة التفاصيل");

                        const db = getFinanceDB();
                        db.push({ id: Date.now(), name, phone, amount, date, status: 'pending' });
                        saveFinanceDB(db);

                        alert("تمت إضافة القسط بنجاح");
                        renderFinanceTable();
                        // Clear inputs
                        document.getElementById('fin-name').value = '';
                        document.getElementById('fin-amount').value = '';
                    }

                    function renderFinanceTable(filter = 'all') {
                        const db = getFinanceDB();
                        const tbody = document.getElementById('finance-table-body');
                        if (!tbody) return;

                        let html = '';
                        db.forEach((item, index) => {
                            // Check Late Status
                            const isLate = new Date(item.date) < new Date() && item.status !== 'paid';
                            if (filter === 'late' && !isLate) return;

                            const statusBadge = item.status === 'paid'
                                ? '<span class="grade-badge grade-good">تم الدفع</span>'
                                : (isLate ? '<span class="grade-badge" style="background:red;">متأخر</span>' : '<span class="grade-badge" style="background:#555;">انتظار</span>');

                            html += `
                        <tr>
                            <td>${item.name} <div style="font-size:0.8rem; color:#aaa;">${item.phone || 'لا يوجد رقم'}</div></td>
                            <td>${item.amount}</td>
                            <td>${item.date}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${item.status !== 'paid' ?
                                    `<button class="btn-glow" style="padding:5px 10px; font-size:0.8rem; margin-left:5px;" onclick="markPaid(${index})">✅ دفع</button>` : ''}
                                
                                ${item.phone && item.status !== 'paid' ?
                                    `<button class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:#25D366; border-color:#25D366; color:#fff;" onclick="sendWhatsApp('${item.phone}', '${item.name}', '${item.amount}')"><i class="fa-brands fa-whatsapp"></i> تذكير</button>` : ''}
                                
                                <button onclick="deleteFinance(${index})" style="background:none; border:none; color:red; cursor:pointer;">❌</button>
                            </td>
                        </tr>`;
                        });
                        tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">لا توجد بيانات</td></tr>';
                    }

                    function markPaid(index) {
                        const db = getFinanceDB();
                        db[index].status = 'paid';
                        saveFinanceDB(db);
                        renderFinanceTable();
                    }

                    function deleteFinance(index) {
                        if (confirm('حذف هذا السجل؟')) {
                            const db = getFinanceDB();
                            db.splice(index, 1);
                            saveFinanceDB(db);
                            renderFinanceTable();
                        }
                    }

                    function sendWhatsApp(phone, name, amount) {
                        // Iraqi format correction: 077... -> 96477...
                        let p = phone.replace(/\D/g, ''); // Remove non-digits
                        if (p.startsWith('0')) p = '964' + p.substring(1);

                        const text = `مرحباً ولي أمر الطالب (${name}) المحترم،\nنود تذكيركم بأن القسط المالي المستحق بقيمة (${amount}) قد حان موعد سداده.\nيرجى مراجعة إدارة إعدادية النهرين المهنية لتسوية الأمر.\nشكراً لتعاونكم.`;

                        window.open(`https://wa.me/${p}?text=${encodeURIComponent(text)}`, '_blank');
                    }
                </script>


                <!-- TAB: STATS -->
                <div id="tab-stats" class="admin-tab" style="display:block;">
                    <div class="glass-panel" style="margin-bottom:20px;">
                        <h3>إحصائيات المدرسة</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <div style="height:300px;"><canvas id="enrollmentChart"></canvas></div>
                            <div style="height:300px;"><canvas id="attendanceChart"></canvas></div>
                        </div>
                    </div>

                    <!-- NEWS EDITOR -->
                    <div class="glass-panel" style="margin-bottom:20px; border: 1px solid var(--primary);">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>📰 شريط الأخبار العاجلة</h3>
                            <button class="btn-glow" onclick="saveNewsTicker()">نشر الخبر</button>
                        </div>
                        <p style="color:#aaa; font-size:0.9rem;">اكتب النص هنا وسيظهر أسفل الشاشة لجميع الزوار فوراً
                        </p>
                        <input id="news-input" class="cyber-input" placeholder="اكتب الخبر العاجل هنا..."
                            style="margin-top:10px;">
                    </div>

                </div>

                <!-- TAB: STAFF -->
                <div id="tab-staff" class="admin-tab">
                    <div class="glass-panel">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                            <h3>قائمة الأساتذة والإداريين</h3>
                            <button class="btn-glow" onclick="adminAddUserUI()">+ إضافة مستخدم</button>
                        </div>
                        <table class="cyber-table">
                            <thead>
                                <tr>
                                    <th>الرمز (كود الدخول)</th>
                                    <th>الاسم</th>
                                    <th>الصلاحية</th>
                                    <th>تحكم</th>
                                </tr>
                            </thead>
                            <tbody id="admin-staff-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: STUDENTS -->
                <div id="tab-students" class="admin-tab" style="display:none;">
                    <div class="glass-panel">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                            <h3>قائمة الطلاب المسجلين</h3>
                            <button class="btn-glow" onclick="showRegistration()">+ تسجيل طالب جديد</button>
                        </div>

                        <!-- BULK IMPORT TOOL -->
                        <div
                            style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px dashed #555;">
                            <h4 style="color: var(--primary); margin-bottom:5px;">📥 رفع الأسماء دفعة واحدة (Bulk
                                Import)
                            </h4>
                            <p style="color:#aaa; font-size:0.9rem;">انسخ أسماء الطلاب من ملف الإكسل والصقها هنا (كل
                                اسم
                                في
                                سطر جديد). سيتم إضافتهم فوراً للشعبة المختارة.</p>

                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <select id="import-class-select" class="cyber-input" style="flex:1;">
                                    <option value="">اختر الشعبة المراد الإضافة إليها...</option>
                                    <option value="cyber-science">الأمن السيبراني - علوم</option>
                                    <option value="cyber-lab">الأمن السيبراني - قاعة الحاسوب</option>
                                    <option value="cyber-2c">الأمن السيبراني - 2C</option>
                                    <option value="cyber-2a">الأمن السيبراني - 2A</option>
                                    <option value="cyber-g6">الأمن السيبراني - G6</option>
                                    <option value="oil-gas">تكرير النفط</option>
                                    <option value="med-inst">الأجهزة الطبية</option>
                                </select>
                                <button class="btn-glow" onclick="processBulkImport()">بدء الاستيراد 🚀</button>
                            </div>
                            <textarea id="import-names-area" class="cyber-input"
                                style="height:120px; margin-top:10px; font-family:inherit;" placeholder="مثال:
علي محمد ياسين
حسين كريم رحيم
سارة أحمد"></textarea>
                        </div>
                        <table class="cyber-table">
                            <thead>
                                <tr>
                                    <th>الرمز</th>
                                    <th>الاسم</th>
                                    <th>التخصص</th>
                                    <th>الحالة</th>
                                    <th>اتصال</th>
                                    <th>تحكم</th>
                                </tr>
                            </thead>
                            <tbody id="admin-students-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: APPS -->
                <div id="tab-apps" class="admin-tab" style="display:none;">
                    <div class="glass-panel">
                        <h3><i class="fa-solid fa-inbox"></i> طلبات القبول والانتساب</h3>
                        <p style="color:#aaa; margin-bottom:15px;">رسائل الطلاب الراغبين بالتسجيل في المدرسة</p>
                        <table class="cyber-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الاسم</th>
                                    <th>القسم المطلوب</th>
                                    <th>المعدل</th>
                                    <th>رقم الهاتف</th>
                                    <th>ملاحظات</th>
                                    <th>تحكم</th>
                                </tr>
                            </thead>
                            <tbody id="admin-apps-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: NFC -->
                <div id="tab-nfc" class="admin-tab" style="display:none;">
                    <div class="glass-panel" style="padding: 30px;">
                        <h3><i class="fa-solid fa-tower-broadcast"></i> مراقبة البوابة الذكية</h3>
                        <div id="terminal-log"
                            style="background:#000; height:150px; overflow-y:auto; font-family:monospace; color:#0f0; padding:10px;">
                            Waiting for connection...</div>
                        <br>
                        <button onclick="connectSerial()" class="btn-glow">اتصال بالجهاز</button>
                        <button onclick="simulateScan()" class="btn-glow">محاكاة دخول</button>
                    </div>
                </div>

                <!-- TAB: GALLERY ADMIN -->
                <div id="tab-gallery-admin" class="admin-tab" style="display:none;">
                    <div class="glass-panel">
                        <h3>🖼️ إدارة معرض الصور</h3>
                        <p style="color:#aaa; font-size:0.9rem;">اضغط على "تغيير الصورة" لرفع صورة جديدة من جهازك
                            مباشرة.
                        </p>
                        <div style="margin-top:20px;">
                            <!-- Image 1 -->
                            <div class="glass-panel"
                                style="border:1px solid #333; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                                <img id="admin-preview-1" src="g1.jpg"
                                    style="width:80px; height:80px; object-fit:cover; border-radius:5px; border:1px solid #555;">
                                <div style="flex:1;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <h4>الصورة الأولى (الرئيسية)</h4>
                                        <button class="btn-glow"
                                            style="padding:5px 10px; font-size:0.7rem; background:rgba(255,0,0,0.3); border-color:red;"
                                            onclick="resetGalleryImage('g1')">🗑️ استعادة الافتراضي</button>
                                    </div>
                                    <input type="file" id="file-g1" accept="image/*" class="cyber-input"
                                        style="padding:5px;" onchange="handleFileSelect('g1', this)">
                                    <input id="admin-g1-title" class="cyber-input" placeholder="عنوان الصورة"
                                        style="margin-top:5px;">
                                </div>
                            </div>

                            <!-- Image 2 -->
                            <div class="glass-panel"
                                style="border:1px solid #333; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                                <img id="admin-preview-2" src="g2.jpg"
                                    style="width:80px; height:80px; object-fit:cover; border-radius:5px; border:1px solid #555;">
                                <div style="flex:1;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <h4>الصورة الثانية</h4>
                                        <button class="btn-glow"
                                            style="padding:5px 10px; font-size:0.7rem; background:rgba(255,0,0,0.3); border-color:red;"
                                            onclick="resetGalleryImage('g2')">🗑️ استعادة الافتراضي</button>
                                    </div>
                                    <input type="file" id="file-g2" accept="image/*" class="cyber-input"
                                        style="padding:5px;" onchange="handleFileSelect('g2', this)">
                                    <input id="admin-g2-title" class="cyber-input" placeholder="عنوان الصورة"
                                        style="margin-top:5px;">
                                </div>
                            </div>

                            <!-- Image 3 -->
                            <div class="glass-panel"
                                style="border:1px solid #333; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                                <img id="admin-preview-3" src="g3.jpg"
                                    style="width:80px; height:80px; object-fit:cover; border-radius:5px; border:1px solid #555;">
                                <div style="flex:1;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <h4>الصورة الثالثة</h4>
                                        <button class="btn-glow"
                                            style="padding:5px 10px; font-size:0.7rem; background:rgba(255,0,0,0.3); border-color:red;"
                                            onclick="resetGalleryImage('g3')">🗑️ استعادة الافتراضي</button>
                                    </div>
                                    <input type="file" id="file-g3" accept="image/*" class="cyber-input"
                                        style="padding:5px;" onchange="handleFileSelect('g3', this)">
                                    <input id="admin-g3-title" class="cyber-input" placeholder="عنوان الصورة"
                                        style="margin-top:5px;">
                                </div>
                            </div>

                            <button class="btn-glow" onclick="saveGallerySettings()">💾 حفظ التغييرات</button>
                        </div>
                    </div>
                </div>

                <!-- TAB: HONOR ROLL ADMIN -->
                <div id="tab-honor-admin" class="admin-tab" style="display:none;">
                    <div class="glass-panel">
                        <h3>🏅 إدارة لوحة الشرف (الأوائل)</h3>
                        <p style="color:#aaa; font-size:0.9rem;">تعديل بيانات الطلبة الأوائل التي تظهر في الصفحة
                            الرئيسية.
                        </p>
                        <div style="margin-top:20px; display:grid; grid-template-columns:repeat(3, 1fr); gap:15px;">
                            <!-- Student 1 -->
                            <div class="glass-panel" style="border-top:3px solid gold; padding:15px;">
                                <h4 style="color:gold;">🥇 المركز الأول</h4>
                                <input id="honor-1-name" class="cyber-input" placeholder="اسم الطالب"
                                    style="margin-bottom:5px;">
                                <input id="honor-1-major" class="cyber-input" placeholder="التخصص / القسم"
                                    style="margin-bottom:5px;">
                                <input id="honor-1-grade" class="cyber-input" placeholder="المعدل (مثال: 99%)">
                            </div>
                            <!-- Student 2 -->
                            <div class="glass-panel" style="border-top:3px solid silver; padding:15px;">
                                <h4 style="color:silver;">🥈 المركز الثاني</h4>
                                <input id="honor-2-name" class="cyber-input" placeholder="اسم الطالب"
                                    style="margin-bottom:5px;">
                                <input id="honor-2-major" class="cyber-input" placeholder="التخصص / القسم"
                                    style="margin-bottom:5px;">
                                <input id="honor-2-grade" class="cyber-input" placeholder="المعدل">
                            </div>
                            <!-- Student 3 -->
                            <div class="glass-panel" style="border-top:3px solid #cd7f32; padding:15px;">
                                <h4 style="color:#cd7f32;">🥉 المركز الثالث</h4>
                                <input id="honor-3-name" class="cyber-input" placeholder="اسم الطالب"
                                    style="margin-bottom:5px;">
                                <input id="honor-3-major" class="cyber-input" placeholder="التخصص / القسم"
                                    style="margin-bottom:5px;">
                                <input id="honor-3-grade" class="cyber-input" placeholder="المعدل">
                            </div>
                        </div>
                        <button class="btn-glow" onclick="saveHonorSettings()" style="width:100%; margin-top:20px;">💾
                            حفظ
                            قائمة
                            الأوائل</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Interface & Logic -->




        <script>
            // ================== CLOUD DATABASE CONFIG (OPTIONAL) ==================
            // لربط الموقع بقاعدة بيانات سحابية (Firebase) وتمكين الدخول من أي مكان:
            // 1. اذهب إلى console.firebase.google.com وأنشئ مشروعاً جديداً.
            // 2. انسخ إعدادات المشروع (Config) والصقها في الأسفل.
            /* 
                    // SIMULATION MODE: Original Init Disabled
                    const firebaseConfig = {
                        apiKey: "AIzaSyBWtURZAw5Kja8S6bHuQyimuhMMX4fZOco",
                        authDomain: "al-nahrain-school-1d9f6.firebaseapp.com",
                        projectId: "al-nahrain-school-1d9f6",
                        storageBucket: "al-nahrain-school-1d9f6.firebasestorage.app",
                        messagingSenderId: "119716570818",
                        appId: "1:119716570818:web:aa200d98166a5a964f3d5b",
                        measurementId: "G-7S4P4T68K5",
                        databaseURL: "https://al-nahrain-school-1d9f6-default-rtdb.firebaseio.com"
                    };
                    // عند توفر المفاتيح، يمكن تفعيل الاتصال:
                    // firebase.initializeApp(firebaseConfig);
                    // const dbRef = firebase.database().ref();
                    // console.log("🔥 FIREBASE CONNECTED");
                    */

            // === REALTIME SYNC ===
            // 1. Pull from Cloud on Load
            // === REALTIME SYNC ===
            // 1. Pull from Cloud on Load
            dbRef.child('schoolDB').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.students) localStorage.setItem('nahr_students_db', JSON.stringify(data.students));
                    if (data.staff) localStorage.setItem('nahr_staff_db', JSON.stringify(data.staff));
                    if (data.apps) {
                        // Ensure apps is stored as Array for local render compatibility
                        const appsList = Array.isArray(data.apps) ? data.apps : Object.values(data.apps);
                        localStorage.setItem('nahr_apps_db', JSON.stringify(appsList));
                    }

                    // Sync New Features (Gallery & Honor Roll)
                    if (data.gallery) {
                        localStorage.setItem('school_gallery_data', JSON.stringify(data.gallery));
                        loadGallerySettings(); // Refresh UI if open
                    }
                    if (data.honor) {
                        localStorage.setItem('school_honor_data', JSON.stringify(data.honor));
                        loadHonorSettings(); // Refresh UI if open
                    }

                    console.log("☁️ Data Synced from Cloud");
                }
            });

            // Sync Auth Users Data
            dbRef.child('users').on('value', (snapshot) => {
                localStorage.setItem('nahr_users_db', JSON.stringify(snapshot.val() || {}));
                // Refresh if Admin Dash is open
                if (document.getElementById('admin-dash').classList.contains('active')) renderAdminLists();
            });

            // 2. Push to Cloud periodically (Auto-Backup & Broadcast)
            setInterval(() => {
                const data = {
                    students: JSON.parse(localStorage.getItem('nahr_students_db') || '{}'),
                    staff: JSON.parse(localStorage.getItem('nahr_staff_db') || '{}'),
                    apps: JSON.parse(localStorage.getItem('nahr_apps_db') || '[]'),
                    gallery: JSON.parse(localStorage.getItem('school_gallery_data') || 'null'), // Sync Gallery
                    honor: JSON.parse(localStorage.getItem('school_honor_data') || 'null')      // Sync Honor Roll
                };

                // Only push if we have data to avoid overwriting cloud with nulls on fresh start
                // ideally we rely on Auth to protect this write (Rules already set!)
                dbRef.child('schoolDB').update(data).catch(err => {
                    // Silent catch for permission errors (Students trying to push)
                    // console.log("Read-only mode for non-admins");
                });
            }, 5000);
            // ======================================================================

            // 0. Boot Sequence Logic
            window.addEventListener('load', () => {
                // Only show boot screen once per session (optional, kept for effect)
                const logs = ["INITIALIZING NAHRAIN OS...", "LOADING CORE MODULES...", "CONNECTING DATABASE...", "ACCESS GRANTED."];
                const logContainer = document.getElementById('boot-log-container');
                const pgBar = document.getElementById('boot-bar');
                let delay = 0;
                logs.forEach((log, index) => {
                    setTimeout(() => {
                        const el = document.createElement('div'); el.className = 'boot-log'; el.innerText = `> ${log}`;
                        logContainer.appendChild(el); setTimeout(() => el.style.opacity = 1, 50);
                        pgBar.style.width = `${((index + 1) / logs.length) * 100}%`;
                    }, delay);
                    delay += 300;
                });
                setTimeout(() => {
                    const screen = document.getElementById('boot-screen');
                    screen.style.transition = 'opacity 0.5s'; screen.style.opacity = 0;
                    setTimeout(() => screen.style.display = 'none', 500);
                }, delay + 500);

                // Load Data
                loadAttendanceData();
            });

            // ================== SECURITY (Login System) ==================
            // ================== SECURITY (Login System) ==================
            let pendingDashboard = null;
            let currentUser = null; // Global User Object

            // Auth State Listener (Persistence)
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log("Auth State: Logged In", user.uid);
                    // Fetch Data
                    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
                        currentUser = snapshot.val();
                        if (currentUser) {
                            currentUser.uid = user.uid; // Ensure UID is attached
                            console.log("User Data Loaded", currentUser);

                            // Update UI if on Teacher Dashboard
                            const teacherWelcome = document.getElementById('teacher-welcome');
                            if (teacherWelcome && currentUser.role === 'teacher') teacherWelcome.innerText = `أهلاً بك، ${currentUser.name}`;
                        }
                    });
                } else {
                    console.log("Auth State: Logged Out");
                    currentUser = null;
                }
            });

            function requestLogin(type) {
                pendingDashboard = type;

                // If already logged in, check permission and Auto-Enter
                if (currentUser) {
                    const role = currentUser.role;
                    if (type === 'admin' && role === 'admin') { openDashboard('admin'); renderAdminLists(); return; }
                    if (type === 'teacher' && (role === 'teacher' || role === 'admin')) { openDashboard('teacher'); return; }
                    if (type === 'student' && role === 'student') { openDashboard('student'); renderStudentDashboard(currentUser); return; }

                    // If Role mismatch, show alert or login again?
                    // Let's allow switching account if role doesn't match
                }

                // Otherwise, show Login Overlay


                // All other portals require auth
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('modal-email').value = '';
                document.getElementById('modal-pass').value = '';
                document.getElementById('modal-error').style.display = 'none';
                // Default to Login Mode
                // toggleAuthMode('login'); // Removed as we have separate Reg Overlay
            }

            function validateLogin() {
                alert('بدء عملية الدخول...'); // DEBUG
                const email = document.getElementById('modal-email').value;
                const pass = document.getElementById('modal-pass').value;
                const err = document.getElementById('modal-error');

                if (!email || !pass) { err.style.display = 'block'; err.innerText = 'يرجى ملء البيانات'; return; }

                err.style.display = 'block'; // Show status
                err.innerText = 'جاري الاتصال...';

                firebase.auth().signInWithEmailAndPassword(email, pass)
                    .then((userCred) => {
                        const user = userCred.user;
                        console.log("Auth Success", user.uid);



                        // Check Role in Database
                        err.innerText = 'جاري التحقق من الصلاحيات...';
                        return firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
                            console.log("DB Read Success", snapshot.val());
                            let userData = snapshot.val();
                            if (userData) currentUser = userData;

                            // === EMERGENCY FIX: If user missing in DB, OR it's the Admin Email ===
                            if (!userData || user.email === '4.eng44@gmail.com') {
                                const newRole = (user.email === '4.eng44@gmail.com') ? 'admin' : 'student';
                                userData = {
                                    name: (user.displayName || 'User'),
                                    email: user.email,
                                    role: newRole,
                                    joined: new Date().toISOString()
                                };
                                // Auto-Repair DB
                                firebase.database().ref('users/' + user.uid).update(userData);
                                alert('تم تصحيح بيانات حسابك تلقائياً! \nصلاحيتك الآن: ' + newRole);
                            }

                            const userRole = userData.role || 'student';

                            // Strict Access Rules
                            if (pendingDashboard === 'admin' && userRole !== 'admin') {
                                alert('⛔ تنبيه أمني:\nهذه المنطقة مخصصة للإدارة فقط.\nليس لديك الصلاحيات الكافية.');
                                err.innerText = 'ليس لديك صلاحية Admin';
                                return;
                            }
                            if (pendingDashboard === 'teacher' && userRole !== 'teacher' && userRole !== 'admin') {
                                alert('⛔ تنبيه:\nبوابة التدريسيين حصرية للكادر التعليمي.');
                                err.innerText = 'ليس لديك صلاحية Teacher';
                                return;
                            }

                            // Access Granted
                            document.getElementById('auth-overlay').style.display = 'none';
                            openDashboard(pendingDashboard);

                            if (pendingDashboard === 'admin') renderAdminLists();
                            if (pendingDashboard === 'teacher') document.getElementById('teacher-welcome').innerText = `أهلاً بك، ${userData.name}`;
                            if (pendingDashboard === 'student') renderStudentDashboard(userData);
                        });
                    })
                    .catch((error) => {
                        console.error("Login Error", error);
                        alert("خطأ في الدخول: " + error.message);
                        err.style.display = 'block';
                        if (error.code === 'auth/user-not-found') err.innerText = 'المستخدم غير موجود';
                        else if (error.code === 'auth/wrong-password') err.innerText = 'كلمة المرور غير صحيحة';
                        else if (error.code === 'auth/network-request-failed') err.innerText = 'خطأ في الاتصال بالإنترنت';
                        else err.innerText = 'خطأ: ' + error.message;
                    });
            }
            function closeAuth() { document.getElementById('auth-overlay').style.display = 'none'; }

            function toggleAuthMode(mode) {
                document.getElementById('modal-error').style.display = 'none';
                if (mode === 'register') {
                    document.getElementById('login-fields').style.display = 'none';
                    document.getElementById('register-fields').style.display = 'block';
                } else {
                    document.getElementById('login-fields').style.display = 'block';
                    document.getElementById('register-fields').style.display = 'none';
                }
            }

            function registerUser() {
                const email = document.getElementById('modal-email').value;
                const pass = document.getElementById('modal-pass').value;
                const name = document.getElementById('modal-name').value;
                const phone = document.getElementById('modal-phone').value;
                const err = document.getElementById('modal-error');

                if (!email || !pass || !name || !phone) { err.style.display = 'block'; err.innerText = 'يرجى ملء جميع الحقول'; return; }
                if (pass.length < 6) { err.style.display = 'block'; err.innerText = 'كلمة المرور قصيرة (6 أحرف على الأقل)'; return; }

                alert('جاري إنشاء الحساب...'); // DEBUG

                firebase.auth().createUserWithEmailAndPassword(email, pass)
                    .then((res) => {
                        alert('تم الاتصال بسيرفر التسجيل!'); // DEBUG
                        // Save Profile (Optional check if DB is connected)
                        const uid = res.user.uid;
                        firebase.database().ref('users/' + uid).set({
                            name: name,
                            email: email,
                            phone: phone,
                            role: 'student',
                            joined: new Date().toISOString()
                        });

                        // Send Verification Email
                        res.user.sendEmailVerification();

                        alert('تم إنشاء الحساب بنجاح! \nأهلاً بك يا ' + name + '\n\n⚠️ تم إرسال رابط تفعيل إلى بريدك الإلكتروني.\nيرجى الضغط عليه لتفعيل الحساب ثم تسجيل الدخول.');

                        // Return to login screen
                        toggleAuthMode('login');
                    })
                    .catch((error) => {
                        alert('فشل التسجيل: ' + error.code); // DEBUG
                        err.style.display = 'block';
                        if (error.code === 'auth/email-already-in-use') err.innerText = 'البريد الإلكتروني مستخدم بالفعل';
                        else if (error.code === 'auth/invalid-email') err.innerText = 'يرجى استخدام بريد إلكتروني حقيقي والصحيح';
                        else if (error.code === 'auth/weak-password') err.innerText = 'كلمة المرور ضعيفة (يجب أن تكون 6 أحرف أو أكثر)';
                        else err.innerText = 'خطأ: ' + error.message;
                    });
            }

            // ================== PERSISTENCE (LocalStorage) ==================
            function saveAttendanceLog(logItem) {
                let logs = JSON.parse(localStorage.getItem('attendanceLogs') || '[]');
                logs.push(logItem);
                // Keep last 50 logs
                if (logs.length > 50) logs.shift();
                localStorage.setItem('attendanceLogs', JSON.stringify(logs));
            }

            function loadAttendanceData() {
                let logs = JSON.parse(localStorage.getItem('attendanceLogs') || '[]');
                const logEl = document.getElementById('terminal-log');
                logs.forEach(log => {
                    logEl.innerHTML += `> ${log}<br>`;
                });
                logEl.innerHTML += `> ----------------------<br>> Log loaded successfully.<br>`;
            }

            // ================== PARTICLES & UI ==================
            const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
            window.addEventListener('resize', resize);
            class Particle {
                constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.size = Math.random() * 2; this.color = Math.random() > 0.5 ? '#00f2ff' : '#7000ff'; }
                update() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > width) this.vx *= -1; if (this.y < 0 || this.y > height) this.vy *= -1; }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); }
            }
            function initParts() { particles = []; for (let i = 0; i < 50; i++) particles.push(new Particle()); }
            function animate() { ctx.clearRect(0, 0, width, height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
            resize(); initParts(); animate();

            document.addEventListener('mousemove', (e) => { const cur = document.getElementById('cursorGlow'); cur.style.left = e.clientX + 'px'; cur.style.top = e.clientY + 'px'; });

            function openDashboard(type) {
                document.querySelectorAll('.dashboard-overlay').forEach(d => d.classList.remove('active'));
                document.getElementById(type + '-dash').classList.add('active');
                document.body.style.overflow = 'hidden';
                if (type === 'admin') {
                    const log = document.getElementById('terminal-log');
                    log.scrollTop = log.scrollHeight;
                    setTimeout(initCharts, 500);
                }
            }
            function closeDashboards() { document.querySelectorAll('.dashboard-overlay').forEach(d => d.classList.remove('active')); document.body.style.overflow = 'auto'; }

            // Chart Rendering
            // Chart Rendering
            let myEnrollChart = null;
            let myAttendChart = null;

            function initCharts() {
                // Collect Data
                const stdDB = getStudentDB();
                const usersDB = JSON.parse(localStorage.getItem('nahr_users_db') || '{}');

                // Counters
                let counts = { 'Cyber': 0, 'Medical': 0, 'Oil': 0, 'New': 0 };

                // Count Legacy
                Object.values(stdDB).forEach(s => {
                    if (s.major && s.major.includes('Cyber')) counts['Cyber']++;
                    else if (s.major && s.major.includes('Medical')) counts['Medical']++;
                    else if (s.major && s.major.includes('Oil')) counts['Oil']++;
                    else counts['New']++;
                });

                // Count Auth Users (Map to 'New' or match regex if Major added later)
                Object.keys(usersDB).forEach(uid => {
                    if (usersDB[uid].role === 'student') counts['New']++;
                });

                const ctx1 = document.getElementById('enrollmentChart');
                if (ctx1) {
                    if (myEnrollChart) myEnrollChart.destroy(); // Refresh
                    myEnrollChart = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['الأمن السيبراني', 'الأجهزة الطبية', 'تكرير النفط', 'طلاب جدد'],
                            datasets: [{
                                data: [counts['Cyber'], counts['Medical'], counts['Oil'], counts['New']],
                                backgroundColor: ['#00f2ff', '#7000ff', '#ff0055', '#cccccc'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: 'white', font: { family: 'Cairo' } } } } }
                    });
                }

                // Attendance Data (Mock for now until Logic implemented)
                const ctx2 = document.getElementById('attendanceChart');
                if (ctx2) {
                    if (myAttendChart) myAttendChart.destroy();
                    myAttendChart = new Chart(ctx2, {
                        type: 'bar',
                        data: { labels: ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'], datasets: [{ label: 'نسبة الحضور %', data: [95, 92, 88, 97, 85], backgroundColor: '#00f2ff', borderRadius: 5 }] },
                        options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: 'white' } }, x: { grid: { display: false }, ticks: { color: 'white', font: { family: 'Cairo' } } } }, plugins: { legend: { labels: { color: 'white', font: { family: 'Cairo' } } } } }
                    });
                }
            }

            // Stats Animation
            document.addEventListener("DOMContentLoaded", () => {
                const stats = document.querySelectorAll('.stat-number');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const counter = entry.target; const target = +counter.getAttribute('data-target'); const prefix = counter.getAttribute('data-prefix') || '';
                            let current = 0; const increment = target / 50;
                            const updateCount = () => { current += increment; if (current < target) { counter.innerText = prefix + Math.ceil(current); requestAnimationFrame(updateCount); } else { counter.innerText = prefix + target; } };
                            updateCount(); observer.unobserve(counter);
                        }
                    });
                }, { threshold: 0.5 });
                stats.forEach(stat => observer.observe(stat));
            });

            // 3D Tilt
            document.querySelectorAll('.spec-card').forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left - rect.width / 2; const y = e.clientY - rect.top - rect.height / 2;
                    card.style.transform = `perspective(1000px) rotateX(${y * -0.1}deg) rotateY(${x * 0.1}deg) scale(1.05)`;
                });
                card.addEventListener('mouseleave', () => { card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)'; });
            });

            function viewGalleryImage(index) {
                const img = document.getElementById('gallery-img-' + index);
                if (img) window.open(img.src, '_blank');
            }

            // ================== NFC / SERIAL ==================
            let port;
            async function connectSerial() {
                if (!navigator.serial) { alert('Web Serial API not supported'); return; }
                try {
                    port = await navigator.serial.requestPort(); await port.open({ baudRate: 9600 });
                    const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text');
                    dot.style.background = '#0f0'; dot.style.boxShadow = '0 0 10px #0f0'; txt.innerText = 'ONLINE'; txt.style.color = '#0f0';
                    readLoop();
                } catch (e) { console.error(e); }
            }
            async function readLoop() {
                const decoder = new TextDecoderStream(); port.readable.pipeTo(decoder.writable); const reader = decoder.readable.getReader();
                try { while (true) { const { value, done } = await reader.read(); if (done) break; if (value.trim()) handleScan(value.trim()); } } catch (e) { console.error(e); }
            }

            function simulateScan() {
                const mockIDs = ["UID: A4-32-BC-91", "UID: BB-11-23-44", "UID: CC-99-88-77"];
                const randomID = mockIDs[Math.floor(Math.random() * mockIDs.length)];
                handleScan(randomID, true);
            }

            function handleScan(data, isSim = false) {
                const log = document.getElementById('terminal-log');
                const time = new Date().toLocaleTimeString('ar-IQ');
                const dateStr = new Date().toLocaleDateString('ar-IQ');

                const logEntry = `[${dateStr} ${time}] CARD: ${data}`;

                // UI Log
                if (isSim) log.innerHTML += `> [SIM] ${logEntry}<br>`;
                else log.innerHTML += `> RECV: ${logEntry}<br>`;
                log.scrollTop = log.scrollHeight;

                // SAVE TO MEMORY
                saveAttendanceLog(logEntry);

                // Visuals
                const frame = document.getElementById('scan-frame'); const icon = document.getElementById('scan-img'); const nameEl = document.getElementById('scan-name');
                frame.style.borderColor = '#0f0'; frame.style.boxShadow = '0 0 30px #0f0'; icon.style.color = '#0f0'; icon.style.transform = 'scale(1.2)';

                const names = ["علي محمد ياسين", "حسين كريم", "سارة احمد", "محمد رضا"];
                const scannedName = names[Math.floor(Math.random() * names.length)];
                nameEl.innerText = scannedName;

                document.getElementById('scan-id').innerText = data; document.getElementById('scan-time').innerText = time;

                setTimeout(() => {
                    frame.style.borderColor = 'var(--primary)'; frame.style.boxShadow = 'none'; icon.style.color = '#333'; icon.style.transform = 'scale(1)';
                }, 2000);

                if (!isSim) speak("تم تسجيل الحضور للطالب " + scannedName);
            }

            document.addEventListener("DOMContentLoaded", () => {
                loadAttendanceData();
                loadGallerySettings(); // Load custom gallery on start
                loadHonorSettings(); // Load honor roll on start
            });

            // ================== GALLERY MANAGEMENT ==================
            function loadGallerySettings() {
                const galleryData = JSON.parse(localStorage.getItem('school_gallery_data')) || {
                    g1: { url: 'g1.jpg', title: 'ساحة التجمع الصباحي' },
                    g2: { url: 'g2.jpg', title: 'القاعات الدراسية الذكية' },
                    g3: { url: 'g3.jpg', title: 'الأنشطة المدرسية' }
                };

                // Update Frontend
                if (document.getElementById('gallery-img-1')) document.getElementById('gallery-img-1').src = galleryData.g1.url;
                if (document.getElementById('gallery-title-1')) document.getElementById('gallery-title-1').innerText = galleryData.g1.title;

                if (document.getElementById('gallery-img-2')) document.getElementById('gallery-img-2').src = galleryData.g2.url;
                if (document.getElementById('gallery-title-2')) document.getElementById('gallery-title-2').innerText = galleryData.g2.title;

                if (document.getElementById('gallery-img-3')) document.getElementById('gallery-img-3').src = galleryData.g3.url;
                if (document.getElementById('gallery-title-3')) document.getElementById('gallery-title-3').innerText = galleryData.g3.title;

                // Update Admin Previews & Titles
                if (document.getElementById('admin-preview-1')) document.getElementById('admin-preview-1').src = galleryData.g1.url;
                if (document.getElementById('admin-g1-title')) document.getElementById('admin-g1-title').value = galleryData.g1.title;

                if (document.getElementById('admin-preview-2')) document.getElementById('admin-preview-2').src = galleryData.g2.url;
                if (document.getElementById('admin-g2-title')) document.getElementById('admin-g2-title').value = galleryData.g2.title;

                if (document.getElementById('admin-preview-3')) document.getElementById('admin-preview-3').src = galleryData.g3.url;
                if (document.getElementById('admin-g3-title')) document.getElementById('admin-g3-title').value = galleryData.g3.title;
            }

            function handleFileSelect(key, input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        // Update Preview
                        document.getElementById('admin-preview-' + key.replace('g', '')).src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            function resetGalleryImage(key) {
                const defaults = {
                    'g1': { url: 'g1.jpg', title: 'ساحة التجمع الصباحي' },
                    'g2': { url: 'g2.jpg', title: 'القاعات الدراسية الذكية' },
                    'g3': { url: 'g3.jpg', title: 'الأنشطة المدرسية' }
                };

                // Revert Preview
                if (document.getElementById('admin-preview-' + key.replace('g', '')))
                    document.getElementById('admin-preview-' + key.replace('g', '')).src = defaults[key].url;

                // Clear Input
                if (document.getElementById('file-' + key))
                    document.getElementById('file-' + key).value = '';

                // Revert Title (Optional, keep if user wants to keep custom title but delete image? Let's reset both to match 'Default')
                if (document.getElementById('admin-' + key + '-title'))
                    document.getElementById('admin-' + key + '-title').value = defaults[key].title;

                // Note: User must still click "Save Changes" to apply this globaly, which is typical for forms.
                // Or we can auto-save? Let's stick to "Save" button for confirmation.
            }

            function saveGallerySettings() {
                // Get current Images (either from upload or existing)
                const img1 = document.getElementById('admin-preview-1').src;
                const img2 = document.getElementById('admin-preview-2').src;
                const img3 = document.getElementById('admin-preview-3').src;

                const newData = {
                    g1: {
                        url: img1,
                        title: document.getElementById('admin-g1-title').value || 'ساحة التجمع الصباحي'
                    },
                    g2: {
                        url: img2,
                        title: document.getElementById('admin-g2-title').value || 'القاعات الدراسية الذكية'
                    },
                    g3: {
                        url: img3,
                        title: document.getElementById('admin-g3-title').value || 'الأنشطة المدرسية'
                    }
                };

                // Limit check (Optional: If Base64 is too massive, localStorage might fail, but for now we assume < 5MB)
                try {
                    localStorage.setItem('school_gallery_data', JSON.stringify(newData));
                    loadGallerySettings(); // Refresh Frontend immediately
                    alert('تم حفظ الصور والعناوين الجديدة بنجاح! ✅');
                } catch (e) {
                    alert('خطأ: حجم الصور كبير جداً للتخزين المحلي. يرجى استخدام صور أصغر حجماً.');
                    console.error(e);
                }
            }

            // ================== HONOR ROLL MANAGEMENT ==================
            function loadHonorSettings() {
                const honorData = JSON.parse(localStorage.getItem('school_honor_data')) || {
                    h1: { name: 'أحمد مهند', major: 'الأول - الأمن السيبراني', grade: 'المعدل: 98.5%' },
                    h2: { name: 'سارة علي', major: 'الأولى - الأجهزة الطبية', grade: 'المعدل: 97.2%' },
                    h3: { name: 'محمد قاسم', major: 'الأول - تكرير النفط', grade: 'المعدل: 96.8%' }
                };

                // Update Frontend
                const updateElement = (id, text) => { if (document.getElementById(id)) document.getElementById(id).innerText = text; };
                updateElement('h1-name', honorData.h1.name);
                updateElement('h1-major', honorData.h1.major);
                updateElement('h1-grade', honorData.h1.grade);

                updateElement('h2-name', honorData.h2.name);
                updateElement('h2-major', honorData.h2.major);
                updateElement('h2-grade', honorData.h2.grade);

                updateElement('h3-name', honorData.h3.name);
                updateElement('h3-major', honorData.h3.major);
                updateElement('h3-grade', honorData.h3.grade);

                // Update Admin Inputs
                const updateInput = (id, val) => { if (document.getElementById(id)) document.getElementById(id).value = val; };
                updateInput('honor-1-name', honorData.h1.name);
                updateInput('honor-1-major', honorData.h1.major);
                updateInput('honor-1-grade', honorData.h1.grade);

                updateInput('honor-2-name', honorData.h2.name);
                updateInput('honor-2-major', honorData.h2.major);
                updateInput('honor-2-grade', honorData.h2.grade);

                updateInput('honor-3-name', honorData.h3.name);
                updateInput('honor-3-major', honorData.h3.major);
                updateInput('honor-3-grade', honorData.h3.grade);
            }

            function saveHonorSettings() {
                const newData = {
                    h1: {
                        name: document.getElementById('honor-1-name').value || 'طالب متميز',
                        major: document.getElementById('honor-1-major').value || 'القسم',
                        grade: document.getElementById('honor-1-grade').value || '99%'
                    },
                    h2: {
                        name: document.getElementById('honor-2-name').value || 'طالب متميز',
                        major: document.getElementById('honor-2-major').value || 'القسم',
                        grade: document.getElementById('honor-2-grade').value || '98%'
                    },
                    h3: {
                        name: document.getElementById('honor-3-name').value || 'طالب متميز',
                        major: document.getElementById('honor-3-major').value || 'القسم',
                        grade: document.getElementById('honor-3-grade').value || '97%'
                    }
                };

                localStorage.setItem('school_honor_data', JSON.stringify(newData));
                loadHonorSettings(); // Refresh view immediately
                alert('تم تحديث قائمة الأوائل بنجاح! 🏆\nHonor Roll updated successfully!');
            }

            // ================== ADVANCED SYSTEM LOGIC ==================
            function getStudentDB() { return JSON.parse(localStorage.getItem('nahr_students_db')) || {}; }
            function saveStudentDB(db) { localStorage.setItem('nahr_students_db', JSON.stringify(db)); }

            function showRegistration() { document.getElementById('reg-overlay').style.display = 'flex'; }
            function closeReg() { document.getElementById('reg-overlay').style.display = 'none'; }

            let regMode = 'student';
            function setRegMode(mode) {
                regMode = mode;
                const btnSt = document.getElementById('btn-mode-student');
                const btnSf = document.getElementById('btn-mode-staff');
                const optSt = document.getElementById('reg-student-opts');
                const optSf = document.getElementById('reg-staff-opts');
                const title = document.getElementById('reg-title');

                if (mode === 'student') {
                    btnSt.style.background = 'var(--primary)'; btnSt.style.color = '#000';
                    btnSf.style.background = 'transparent'; btnSf.style.color = '#fff';
                    optSt.style.display = 'block';
                    optSf.style.display = 'none';
                    title.innerText = '📝 إنشاء حساب طالب جديد';
                } else {
                    btnSf.style.background = 'var(--primary)'; btnSf.style.color = '#000';
                    btnSt.style.background = 'transparent'; btnSt.style.color = '#fff';
                    optSt.style.display = 'none';
                    optSf.style.display = 'block';
                    title.innerText = '🛡️ تسجيل كادر تدريسي/إداري';
                }
            }

            function processRegistration() {
                const name = document.getElementById('reg-name').value;
                const phone = document.getElementById('reg-phone').value; // Get Phone
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-pass').value;
                const status = document.getElementById('reg-status');

                // Logic based on Mode
                let role = 'student';
                let major = '';

                if (regMode === 'student') {
                    major = document.getElementById('reg-class').value;
                    if (!major) return alert('يرجى اختيار الشعبة');
                    if (!phone) return alert('يرجى إدخال رقم واتساب ولي الأمر'); // Validate Phone
                } else {
                    // Staff Validation
                    role = document.getElementById('reg-role').value;
                    const secret = document.getElementById('reg-secret').value;

                    if (role === 'admin' && secret !== 'NAHR-ADMIN') return alert('⛔ رمز الأمان الخاص بالإدارة غير صحيح!');
                    if (role === 'teacher' && secret !== 'NAHR-TEACH') return alert('⛔ رمز الأمان للكادر التدريسي غير صحيح!');
                    major = 'staff';
                }

                if (!name || !email || !pass) return alert('يرجى ملء جميع الحقول المطلوبة');
                if (pass.length < 6) return alert('كلمة المرور يجب أن تكون 6 رموز على الأقل');

                status.innerText = 'جاري إنشاء الحساب في السحابة...';

                // 1. Create Auth User
                firebase.auth().createUserWithEmailAndPassword(email, pass)
                    .then((userCred) => {
                        const user = userCred.user;
                        status.innerText = 'تم إنشاء الحساب! جاري حفظ البيانات...';

                        // 2. Save User Data to Realtime Database
                        const userData = {
                            name: name,
                            phone: phone, // Save Phone
                            email: email,
                            role: role,
                            major: major,
                            joined: new Date().toISOString()
                        };

                        // Add default grades structure only for students
                        if (role === 'student') {
                            userData.grades = {};
                            userData.gradesDetail = {};
                        }

                        return firebase.database().ref('users/' + user.uid).set(userData);
                    })
                    .then(() => {
                        status.innerText = '✅ تم التسجيل بنجاح! (' + (role === 'student' ? 'طالب' : 'كادر') + ')';
                        status.style.color = '#0f0';

                        setTimeout(() => {
                            closeReg();
                            alert('تم إنشاء الحساب بنجاح.\nيرجى استخدام البريد وكلمة المرور للدخول.');
                        }, 1500);
                    })
                    .catch((error) => {
                        console.error(error);
                        status.innerText = 'خطأ: ' + error.message;
                        status.style.color = 'red';
                    });
            }

            function openStudentDashboard(st) {
                const d = document.getElementById('student-dash');
                d.querySelector('h1').innerHTML = `<i class="fa-solid fa-user-graduate"></i> مرحباً، ${st.name}`;
                d.querySelector('.floating-badge').innerText = st.major;
                document.getElementById('student-installments-body').innerHTML = st.installments.map(i => `<tr><td>${i.m}</td><td>${i.v}</td><td>${getStatusBadge(i.s)}</td></tr>`).join('');

                const tbody = document.getElementById('student-grades-body');
                const g = st.grades || {};
                if (Object.keys(g).length === 0) tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">لا توجد درجات</td></tr>`;
                else tbody.innerHTML = Object.entries(g).map(([s, v]) => `<tr><td>${s}</td><td>${v}</td><td>${v >= 90 ? 'ممتاز' : v >= 50 ? 'ناجح' : 'راسب'}</td></tr>`).join('');

                openDashboard('student');
            }
            function getStatusBadge(s) { return s === 'paid' ? '<span class="grade-badge grade-good">تم</span>' : '<span class="grade-badge" style="color:red">غير مدفوع</span>'; }

            // ================== ADMIN & STAFF LOGIC ==================
            function getStaffDB() {
                let db = JSON.parse(localStorage.getItem('nahr_staff_db'));
                if (!db) {
                    // SEED INITIAL DATA
                    db = {
                        "2001": { name: "الأستاذ حسن", subjects: ["CS"], role: 'teacher', code: '2001' },
                        "admin": { name: "المسؤول (Admin)", subjects: ["ALL"], role: 'admin', code: 'admin' },
                        "1234": { name: "المسؤول (Master)", subjects: ["ALL"], role: 'admin', code: '1234' }
                    };
                    localStorage.setItem('nahr_staff_db', JSON.stringify(db));
                }
                return db;
            }
            function saveStaffDB(db) { localStorage.setItem('nahr_staff_db', JSON.stringify(db)); }

            // -------------- APPLICATIONS LOGIC --------------
            function getAppsDB() { return JSON.parse(localStorage.getItem('nahr_apps_db')) || []; }
            function saveAppsDB(db) { localStorage.setItem('nahr_apps_db', JSON.stringify(db)); }

            function showApplication() { document.getElementById('apply-overlay').style.display = 'flex'; }

            function submitApplication() {
                const name = document.getElementById('app-name').value;
                const school = document.getElementById('app-school').value;
                const major = document.getElementById('app-major').value;
                const avg = document.getElementById('app-avg').value;
                const phone = document.getElementById('app-phone').value;

                if (!name || !phone || !major) return alert("يرجى ملء الاسم، الرقم والقسم المطلوب");

                const appData = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ar-IQ'),
                    name: name,
                    school: school,
                    major: major,
                    avg: avg,
                    phone: phone
                };

                // Push directly to Firebase to ensure Admin receives it
                firebase.database().ref('schoolDB/apps').push(appData)
                    .then(() => {
                        alert("تم إرسال طلبك بنجاح! \nبياناتك محفوظة في النظام المركزي وستتصل بك الإدارة قريباً.");
                        // Clear Fields
                        document.getElementById('app-name').value = '';
                        document.getElementById('app-school').value = '';
                        document.getElementById('app-avg').value = '';
                        document.getElementById('app-phone').value = '';
                    })
                    .catch((error) => {
                        console.error("Submission Error:", error);
                        // Fallback to LocalStorage if offline
                        const db = getAppsDB();
                        db.push(appData);
                        saveAppsDB(db);
                        alert("تم حفظ الطلب محلياً (لا يوجد اتصال) \nسيتم تزامنه عند عودة الإنترنت.");
                    });

                // Handle UI (Overlay optional)
                const overlay = document.getElementById('apply-overlay');
                if (overlay) overlay.style.display = 'none';

                // Refresh Admin View if open
                if (document.getElementById('admin-dash').classList.contains('active')) renderAdminLists();
            }

            function deleteApp(id) {
                if (confirm("حذف الطلب؟")) {
                    let db = getAppsDB();
                    db = db.filter(a => a.id != id);
                    saveAppsDB(db);
                    renderAdminLists();
                }
            }

            // Global State for Edit Mode
            let editingStaffCode = null;

            // -------------- ADMIN UI --------------
            function showAdminTab(tab) {
                // ... existing code ...
                document.querySelectorAll('.admin-tab').forEach(t => {
                    t.style.display = 'none';
                });
                const el = document.getElementById('tab-' + tab);
                if (el) el.style.display = 'block';
                if (['students', 'staff', 'apps'].includes(tab)) renderAdminLists();
            }

            // ... renderAdminLists is already defined below ...

            // STAFF ACTIONS
            function __legacy_addStaff() {
                const name = document.getElementById('new-staff-name').value;
                // If editing, get code from global var, else from input
                const codeInput = document.getElementById('new-staff-code');
                const code = editingStaffCode || codeInput.value;
                const role = document.getElementById('new-staff-role').value;
                const subs = document.getElementById('new-staff-subjects').value;

                if (!name || !code) return alert("يرجى ملء الاسم والكود");

                const db = getStaffDB();

                // Validation: strict check only if NOT editing
                if (!editingStaffCode && db[code]) return alert("هذا الكود مستخدم بالفعل");

                // Parse subjects
                const subjectArray = subs ? subs.split(',').map(s => s.trim()) : [];
                if (role === 'admin' && subjectArray.length === 0) subjectArray.push('ALL');

                // Save/Update
                db[code] = { name, code, role, subjects: subjectArray };
                saveStaffDB(db);

                // Reset UI
                editingStaffCode = null;
                renderAdminLists();

                alert(editingStaffCode ? "تم تحديث بيانات الأستاذ بنجاح" : "تمت إضافة الأستاذ بنجاح");
            }

            function __legacy_editStaff(code) {
                const db = getStaffDB();
                const staff = db[code];
                if (!staff) return;

                editingStaffCode = code; // Lock to this user
                renderAdminLists(); // Switch UI to Edit Mode

                // Populate Form (must happen after render)
                setTimeout(() => {
                    document.getElementById('new-staff-name').value = staff.name;
                    document.getElementById('new-staff-code').value = staff.code;
                    document.getElementById('new-staff-subjects').value = (staff.subjects || []).join(', ');
                    document.getElementById('new-staff-role').value = staff.role;
                    document.getElementById('new-staff-name').focus();
                }, 50);
            }

            function __legacy_cancelEdit() {
                editingStaffCode = null;
                renderAdminLists();
            }

            function renderAdminLists() {
                // Render Students
                const stdDB = getStudentDB();
                const usersDB = JSON.parse(localStorage.getItem('nahr_users_db') || '{}');
                const stdTbody = document.getElementById('admin-students-table');

                // Merge Legacy + Auth Users
                const allStudents = [...Object.values(stdDB)];
                Object.keys(usersDB).forEach(uid => {
                    const u = usersDB[uid];
                    if (u.role === 'student') {
                        // Map Auth User to Student Structure
                        allStudents.push({
                            code: 'APP',
                            name: u.name,
                            major: u.major || 'جديد',
                            isBlocked: false,
                            phone: u.phone || '',
                            email: u.email
                        });
                    }
                });

                if (stdTbody) {
                    stdTbody.innerHTML = allStudents.map(s => {
                        const whatsApp = s.phone ? `<a href="https://wa.me/${s.phone.replace(/[^0-9]/g, '').replace(/^0/, '+964')}" target="_blank" style="color:#25D366; font-size:1.2rem; text-decoration:none;"><i class="fa-brands fa-whatsapp"></i></a>` : '<span style="color:#555">-</span>';
                        return `
                    <tr>
                        <td style="font-family:monospace;">${s.code}</td>
                        <td>${s.name}<br><span style="font-size:0.7rem; color:#aaa;">${s.email || ''}</span></td>
                        <td>${s.major}</td>
                        <td>${s.isBlocked ? '<span style="color:red">محظور</span>' : '<span style="color:green">نشط</span>'}</td>
                        <td style="text-align:center;">${whatsApp}</td>
                        <td>
                            <button class="btn-glow" style="padding:2px 10px; font-size:0.7rem;" onclick="toggleBlock('${s.uid || s.code}')">${s.isBlocked ? 'فك الحظر' : 'حظر'}</button>
                        </td>
                    </tr>
                `}).join('');
                }

                // 2. Staff Management (Updated with Edit UI)
                const staffDB = getStaffDB();
                const staffBody = document.getElementById('admin-staff-list');
                if (staffBody) {
                    // UI State based on Editing Mode
                    let btnText = (typeof editingStaffCode !== 'undefined' && editingStaffCode) ? '💾 حفظ التعديلات' : '➕ إضافة';
                    let btnColor = (typeof editingStaffCode !== 'undefined' && editingStaffCode) ? '#0f0' : 'var(--primary)'; // Green for Save
                    let codeDisabled = (typeof editingStaffCode !== 'undefined' && editingStaffCode) ? 'disabled style="opacity:0.5; background:#333;"' : '';
                    let cancelBtn = (typeof editingStaffCode !== 'undefined' && editingStaffCode) ? `<button class="btn-glow" style="background:red; border-color:red;" onclick="cancelEdit()">إلغاء</button>` : '';

                    let html = `
                <div style="margin-bottom:15px; background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; display:flex; gap:10px; align-items:center;">
                    <input id="new-staff-name" class="cyber-input" placeholder="اسم الأستاذ" style="flex:1">
                    <input id="new-staff-code" class="cyber-input" placeholder="كود الدخول" style="width:100px;" ${codeDisabled}>
                    <input id="new-staff-subjects" class="cyber-input" placeholder="المواد (مثال: C++,Linux)" style="flex:1;">
                    <select id="new-staff-role" class="cyber-input"><option value="teacher">مدرس</option><option value="admin">مدير</option></select>
                    <button class="btn-glow" style="background:${btnColor}; color:#000; font-weight:bold;" onclick="performAddStaff()">${btnText}</button>
                    ${(typeof editingStaffCode !== 'undefined' && editingStaffCode) ? `<button class="btn-glow" style="background:red; border-color:red;" onclick="performCancelEdit()">إلغاء</button>` : ''}
                </div>
                <table class="data-table" style="width:100%">
                    <thead><tr><th>الاسم</th><th>Code</th><th>المواد</th><th>الدور</th><th>تحكم</th></tr></thead><tbody>`;

                    Object.values(staffDB).forEach(s => {
                        html += `<tr>
                        <td>${s.name}</td>
                        <td>${s.code}</td>
                        <td>${(s.subjects || []).join(', ')}</td>
                        <td>${s.role === 'admin' ? '🛡️ مسؤول' : '👨‍🏫 مدرس'}</td>
                        <td>
                            <button onclick="performEditStaff('${s.code}')" style="color:var(--secondary); background:none; border:none; cursor:pointer; margin-left:10px;" title="تعديل"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="performRemoveStaff('${s.code}')" style="color:red; background:none; border:none; cursor:pointer;" title="حذف"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                    });
                    html += '</tbody></table>';
                    staffBody.innerHTML = html;
                }

                // 3. Render Apps
                const appsDB = JSON.parse(localStorage.getItem('nahr_apps_db') || '[]');
                const appTbody = document.getElementById('admin-apps-table'); // Using appTbody as in original
                if (appTbody && appTbody.parentElement.checkVisibility()) { // Only render if visible to save perf
                    appTbody.innerHTML = appsDB.map(a => `
                    <tr>
                        <td>${a.date}</td>
                        <td>${a.name}</td>
                        <td style="color:var(--secondary)">${a.major || '-'}</td>
                        <td>${a.avg}</td>
                        <td>${a.phone}</td>
                        <td style="font-size:0.8rem">${a.school}</td>
                        <td><button class="btn-glow" style="padding:2px 10px; font-size:0.7rem; background:red;" onclick="deleteApp(${a.id})">حذف</button></td>
                    </tr>
                `).join('');
                }
            }

            // ADMIN ACTIONS
            function processBulkImport() {
                const classSelect = document.getElementById('import-class-select');
                const textArea = document.getElementById('import-names-area');
                const major = classSelect.value;
                const text = textArea.value.trim();

                if (!major) return alert("يرجى اختيار الشعبة أولاً!");
                if (!text) return alert("يرجى لصق الأسماء أولاً!");

                const lines = text.split('\n');
                let updates = {};
                let count = 0;

                lines.forEach((line) => {
                    const name = line.trim();
                    if (name) {
                        // Generate Unique ID (Fake UID for Non-Auth Student)
                        // We prefix with 'std_' so we can identify them later
                        const uid = 'std_' + major + '_' + Date.now() + '_' + Math.floor(Math.random() * 1000);

                        updates['users/' + uid] = {
                            name: name,
                            role: 'student',
                            major: major,
                            joined: new Date().toISOString(),
                            grades: {},
                            gradesDetail: {}
                        };
                        count++;
                    }
                });

                if (Object.keys(updates).length > 0) {
                    if (confirm(`سيتم إضافة ${count} طالب للشعبة المختارة في السحابة (Online). هل أنت متأكد؟`)) {
                        firebase.database().ref().update(updates).then(() => {
                            alert(`✅ تم حفظ ${count} طالب بنجاح في قاعدة البيانات السحابية!`);
                            textArea.value = ''; // Clear
                            renderAdminLists(); // Refresh List
                        }).catch(e => alert("خطأ في الاتصال: " + e.message));
                    }
                } else {
                    alert("لم يتم العثور على أسماء صالحة.");
                }
            }

            // News Ticker Logic
            function saveNewsTicker() {
                const txt = document.getElementById('news-input').value;
                if (!txt) return alert("يرجى كتابة الخبر");
                firebase.database().ref('schoolDB/news').set(txt)
                    .then(() => alert("✅ تم نشر الخبر بنجاح!"))
                    .catch(err => alert("خطأ: " + err.message));
            }

            // Listen for News Updates
            firebase.database().ref('schoolDB/news').on('value', (snap) => {
                const txt = snap.val();
                const container = document.getElementById('dynamic-ticker-content');
                if (txt && container) {
                    // Clear old items and show new one
                    container.innerHTML = `<div class="ticker-item" style="color:#0f0; font-weight:bold; font-size:1.1rem;"><i class="fa-solid fa-bullhorn"></i> ${txt}</div>`;
                }
            });

            function adminAddUserUI() {
                const code = prompt("أدخل كود الدخول الجديد (كلمة المرور):");
                if (!code) return;
                // Check collision
                const db = getStaffDB(); if (db[code]) return alert('الكود مستخدم!');

                const name = prompt("أدخل اسم الأستاذ:");
                if (!name) return;

                db[code] = { name: name, subjects: ["ALL"], role: 'teacher', code: code };
                saveStaffDB(db);
                renderAdminLists();
            }
            function deleteStaff(code) {
                if (code === 'admin' || code === '1234') return alert('لا يمكن حذف المسؤول');
                if (confirm('حذف المستخدم؟')) {
                    const db = getStaffDB(); delete db[code]; saveStaffDB(db); renderAdminLists();
                }
            }
            function editStaff(oldCode) {
                const db = getStaffDB();
                const u = db[oldCode];
                const newCode = prompt("تعديل الكود (حالياً " + oldCode + "):", oldCode);
                if (newCode && newCode !== oldCode) {
                    if (db[newCode]) return alert("الكود مستخدم!");
                    u.code = newCode;
                    db[newCode] = u;
                    delete db[oldCode];
                    saveStaffDB(db);
                    renderAdminLists();
                }
            }
            function toggleBlock(code) {
                const db = getStudentDB(); if (db[code]) { db[code].isBlocked = !db[code].isBlocked; saveStudentDB(db); renderAdminLists(); }
            }
            function deleteStudent(code) {
                if (confirm("حذف الطالب نهائياً؟")) { const db = getStudentDB(); delete db[code]; saveStudentDB(db); renderAdminLists(); }
            }



            function embeddedLogin() {
                const type = document.getElementById('embedded-type').value;
                const code = document.getElementById('embedded-code').value;
                if (type === 'student') {
                    const db = getStudentDB();
                    if (db[code]) {
                        if (db[code].isBlocked) return alert('حسابك موقوف مؤقتاً. راجع الإدارة.');
                        openStudentDashboard(db[code]);
                    } else {
                        document.getElementById('embedded-error').style.display = 'block';
                        setTimeout(() => document.getElementById('embedded-error').style.display = 'none', 3000);
                    }
                } else {
                    // Teacher/Admin Check from STAFF DB
                    const staffDB = getStaffDB();

                    if (staffDB[code]) {
                        currentUser = staffDB[code];
                        if (currentUser.role === 'admin') {
                            openDashboard('admin');
                            renderAdminLists(); // Init view
                        }
                        else {
                            document.getElementById('teacher-welcome').innerText = `أهلاً بك، ${currentUser.name}`;
                            openDashboard('teacher');
                        }
                    } else {
                        document.getElementById('embedded-error').style.display = 'block';
                        setTimeout(() => document.getElementById('embedded-error').style.display = 'none', 3000);
                    }
                }
            }


            // Check Permissions when Subject Changes
            function checkSubjectPermission() {
                const subjectSelect = document.getElementById('teacher-subject-select');
                const gradeInput = document.getElementById('grade-input');
                const submitBtn = document.getElementById('grade-submit-btn');
                const permissionBadge = document.getElementById('permission-badge');

                const selectedSubject = subjectSelect.value;

                if (!currentUser) return;

                // Admin check
                if (currentUser.role === 'admin') {
                    enableEditing(true);
                    return;
                }

                // Teacher check (If subjects array exists)
                if (currentUser.role === 'teacher' && currentUser.subjects && currentUser.subjects.includes(selectedSubject)) {
                    enableEditing(true);
                } else if (currentUser.role === 'teacher' && !currentUser.subjects) {
                    // Temporary: Allow new teachers to edit ALL until we assign subjects
                    enableEditing(true);
                } else {
                    enableEditing(false);
                }

                function enableEditing(canEdit) {
                    if (canEdit) {
                        gradeInput.disabled = false;
                        gradeInput.style.opacity = "1";
                        gradeInput.placeholder = "0 - 100";
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = "1";
                        submitBtn.innerHTML = 'رصد الدرجة';
                        document.getElementById('grade-actions').style.display = 'block'; // Show Gradebook Button
                        permissionBadge.innerHTML = '<i class="fa-solid fa-pen"></i> وضع التعديل';
                        permissionBadge.className = "grade-badge grade-good";
                        permissionBadge.style.background = "rgba(0, 255, 0, 0.1)";
                        permissionBadge.style.color = "#0f0";
                    } else {
                        gradeInput.disabled = true;
                        gradeInput.style.opacity = "0.5";
                        gradeInput.placeholder = "للإطلاع فقط";
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = "0.5";
                        submitBtn.innerHTML = '<i class="fa-solid fa-lock"></i> مقفل';
                        permissionBadge.innerHTML = '<i class="fa-solid fa-eye"></i> مشاهدة فقط';
                        permissionBadge.className = "grade-badge";
                        permissionBadge.style.background = "rgba(255, 255, 0, 0.1)";
                        permissionBadge.style.color = "yellow";
                        permissionBadge.style.borderColor = "yellow";
                    }
                }
            }

            // ================== DATA STORE (MOCK DB) ==================
            const schoolData = {
                "cyber-science": {
                    name: "الأمن السيبراني - شعبة العلوم",
                    subjects: ["المبادئ الأساسية للحاسوب", "تجميع الحاسوب", "أساسيات الكهرباء", "الاتصالات", "الرياضيات", "اللغة العربية", "اللغة الإنجليزية", "الطبيعيات", "تطبيقات الحاسوب"],
                    students: [
                        "احمد بدر لايذ", "احمد حسن فاضل جيجان", "اسماعيل علي قاسم", "امير كريم حسن", "أمير عبد الرسول فليح",
                        "حسن جاسم عبدالامير", "حسين علي عبد الحر", "حسين علي عبد الواحد", "حسين عماد ثامر", "حسين محمد جابر",
                        "سجاد أحمد علي", "سجاد حسام فالح عبد السادة", "عباس سعد عبد العزيز", "عبدالله علي حسين علي", "علي حسين كشيش",
                        "علي خالد كريم شاكر", "علي سلمان عبدالله", "مجتبى رعد كاظم فزاع", "محمد الجوادين حسين", "محمد خالد رهيف عواد",
                        "محمد زهير فيصل", "محمد علي حسين زاير", "محمد علي صبري", "محمد علي عدنان حيدر", "محمد كريم طه",
                        "محمد مجيد جمعة", "محمد مهدي احمد سعود", "محمد مهند لطيف صاحب", "مرتضى عبد العزيز عبد الحسن", "مصطفى عبدالله شلاكه",
                        "مصطفى كاظم باني", "مهدي احمد كريم", "مهدي رعد سعد فاضل", "محمد احسان علي", "علي حيدر رحيم سلمان", "حسين علي قاسم"
                    ]
                },
                "cyber-lab": {
                    name: "الأمن السيبراني - قاعة الحاسوب",
                    subjects: ["المبادئ الأساسية للحاسوب", "تجميع الحاسوب", "أساسيات الكهرباء", "الاتصالات", "الرياضيات", "اللغة العربية", "اللغة الإنجليزية", "الطبيعيات", "تطبيقات الحاسوب"],
                    students: [
                        "ابو الحسن علي عبد الحسين", "امير بندر زاعل", "امير حيدر محمد خضير", "امير رياض سعد عبد الكريم", "امير علي هادي",
                        "باقر باسل كاظم", "حسين ثبات كريم", "حسين سمير جودة", "حسين علي رزاق", "حسين محمد مهدي محمد صالح",
                        "حسين مزعل منديل", "حسين ناظم حمد سلمان", "حسين وسام مهدي", "رضا مطر سند", "سجاد رعد علي سالم",
                        "سجاد محمد عبد الامير", "سجاد مرعي فيصل", "عباس خالد جابر", "علي احمد ميران سلمان", "علي أحمد عبد الكريم",
                        "علي جميل زعل", "علي حسين حنين", "علي حسين محمد فرج", "علي حيدر فليح", "علي حيدر هويدي",
                        "علي قصي شاكر محسن", "علي كرم علي محمد", "علي هادي عواد", "محمد جاسم محمد", "مرتضى مظفر قاسم",
                        "مصطفى اركان مجدي", "منتظر وسام داخل", "مؤمل ابراهيم رحيم"
                    ]
                },
                "cyber-2c": {
                    name: "الأمن السيبراني - شعبة 2C",
                    subjects: ["المبادئ الأساسية للحاسوب", "تجميع الحاسوب", "أساسيات الكهرباء", "الاتصالات", "الرياضيات", "اللغة العربية", "اللغة الإنجليزية", "الطبيعيات", "تطبيقات الحاسوب"],
                    students: [
                        "امنة عبد الحمزة", "حوراء حيدر حمودي", "حوراء ستار جبار", "رسل ريسان", "رقية باسم اكريم",
                        "رقية رائد كاظم", "رقية سعد مدلول", "رقية صلاح هادي", "رقية على غازي محمد", "روان حسن هادي عباس",
                        "زهراء عباس اسماعيل", "زهراء فاضل حمزه", "زهراء فهد غافل", "زهراء مثنى كاظم", "زينب قاسم كريم",
                        "فاطمة الزهراء رائد فاضل", "فاطمة عبد العزيز فرحان", "فاطمة قاسم شهد", "فاطمة كريم عبدالله", "مروة محمد حدران هاشم",
                        "مريم مصلح محمد محسن", "ملاك حيدر حميد", "نور البتول ثبات حمزة", "نور خضير عباس", "هدى سعد عزيز",
                        "هدى عبد الامير غافل", "ورورد عمار احمد", "يارا حيدر حسن مصطفى علي", "يقين ثامر محمود"
                    ]
                },
                "cyber-2a": {
                    name: "الأمن السيبراني - شعبة 2A",
                    subjects: ["المبادئ الأساسية للحاسوب", "تجميع الحاسوب", "أساسيات الكهرباء", "الاتصالات", "الرياضيات", "اللغة العربية", "اللغة الإنجليزية", "الطبيعيات", "تطبيقات الحاسوب"],
                    students: [
                        "احمد اكرم عبد الكريم", "احمد قاسم محمد", "اسحاق وليد خالد", "رضا ريسان كريم محمد", "سجاد رياض جبار",
                        "صادق ميثم هاشم", "عباس احمد ابراهيم", "عباس حسين علوان عويجل", "عباس عبدالله عطشان", "عباس مبارك جلال حصيد",
                        "علي حسين موحي", "علي فراس موحان", "علي ماهر غازي", "محمد عباس هاشم", "مصطفى سمير عبد الجبار",
                        "مهند محمد علي", "هادي بريس صبري", "محمد قاسم جهادي", "علي ضياء عامر", "مرتضى فرج كاظم",
                        "همام محمد صبر", "ضرغام كاظم عليوي", "منتظر اياد عبد عيدان", "علي مرتضى ابراهيم", "محمد الجواد حسن",
                        "زين العابدين حسين جفات", "حسين اياد كامل", "مصطفى جاسم محمد", "ليث فارس شناوه"
                    ]
                },
                "cyber-g6": {
                    name: "الأمن السيبراني - شعبة G6",
                    subjects: ["المبادئ الأساسية للحاسوب", "تجميع الحاسوب", "أساسيات الكهرباء", "الاتصالات", "الرياضيات", "اللغة العربية", "اللغة الإنجليزية", "الطبيعيات", "تطبيقات الحاسوب"],
                    students: [
                        "جعفر سامي ناهي", "جعفر عدي غالي", "حسن احمد نوري", "حسنين حمكت جواد", "حسين حيدر كريم",
                        "حسين علي قاسم كاطع", "ذوالفقار ستار نشمي", "رضا فواز خليف", "زين العابدين حيدر منور", "سيف حيدر زميل",
                        "سيف حيدر مجيد", "صادق حسين صالح", "علي بسام دوشي", "علي حبيب ناجي", "علي حيدر حمزة",
                        "علي حيدر علي عبد فرهود", "علي سعد عبدالرزاق", "علي سلام ناهي", "عمار عماد كريم", "محمد احسان عباس",
                        "محمد احمد محمد عبد الكريم", "مسلم عقيل غالي", "مصطفى خالد فاضل", "مصظفى علاء الدين عزيز", "منتظر نايف سعود",
                        "مؤمل صاحب شباط", "ايهم مهند هادي", "سجاد حسنين خضر", "مؤمل ليث حسين"
                    ]
                },
                "oil-gas": {
                    name: "تكرير النفط والغاز",
                    subjects: ["كيمياء النفط", "ديناميكا حرارية", "الرسم الهندسي", "السلامة الصناعية"],
                    students: [] // Waiting for data
                }
            };

            // Load Students (FROM FIREBASE)
            function loadClassStudents() {
                const classSelect = document.getElementById('teacher-class-select');
                const studentSelect = document.getElementById('teacher-student-select');
                const subjectSelect = document.getElementById('teacher-subject-select');
                const tableReview = document.getElementById('class-list-preview');
                const tableBody = document.getElementById('students-table-body');
                const selectedClassKey = classSelect.value;

                // Reset
                studentSelect.innerHTML = '<option value="">جاري التحميل...</option>';
                subjectSelect.innerHTML = '<option value="">اختر المادة...</option>';
                tableBody.innerHTML = '<tr><td colspan="3">جاري جلب البيانات من السحابة...</td></tr>';
                tableReview.style.display = 'block';

                if (!selectedClassKey) { tableReview.style.display = 'none'; return; }

                // 1. Get Subjects (Static Config)
                const staticData = schoolData[selectedClassKey] || { subjects: ['مادة عامة'] };
                // Populate Subjects
                const subs = staticData.subjects && staticData.subjects.length ? staticData.subjects : ['مادة عامة'];
                subjectSelect.innerHTML = '<option value="">اختر المادة...</option>';
                subs.forEach(sub => {
                    const opt = document.createElement('option'); opt.value = sub; opt.innerText = sub; subjectSelect.appendChild(opt);
                });

                // 2. Fetch Users from Firebase
                firebase.database().ref('users').once('value').then(snapshot => {
                    studentSelect.innerHTML = '<option value="">اختر الطالب...</option>';
                    tableBody.innerHTML = '';

                    const users = snapshot.val() || {};
                    let found = false;

                    Object.keys(users).forEach((uid, index) => {
                        const u = users[uid];
                        // Filter by Role (Student) AND Major logic
                        if (u.role === 'student' && u.major === selectedClassKey) {
                            found = true;

                            // Add to Dropdown (Legacy)
                            const opt = document.createElement('option');
                            opt.value = uid;
                            opt.innerText = `${u.name}`;
                            studentSelect.appendChild(opt);

                            // Add to Table
                            tableBody.innerHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${u.name}</td>
                            <td id="status-${uid}" style="color:${u.grades ? '#0f0' : '#aaa'}">${u.grades ? 'تم التقييم' : 'جديد'}</td>
                        </tr>`;
                        }
                    });

                    if (subjectSelect.value) document.getElementById('grade-actions').style.display = 'block';

                    if (!found) {
                        tableBody.innerHTML = '<tr><td colspan="3">لا يوجد طلاب مسجلين في هذه الشعبة</td></tr>';
                    }
                }).catch(err => {
                    alert('خطأ في تحميل الطلاب: ' + err.message);
                    tableBody.innerHTML = '<tr><td colspan="3" style="color:red">فشل الاتصال</td></tr>';
                });
            }

            // Grading Logic (SAVE TO FIREBASE)
            document.addEventListener('click', function (e) {
                if (e.target && e.target.id === 'grade-submit-btn') {
                    const uid = document.getElementById('teacher-student-select').value; // This is now Firebase UID
                    const sub = document.getElementById('teacher-subject-select').value;
                    const val = document.getElementById('grade-input').value;

                    if (!uid || !sub) return alert('يرجى اختيار الطالب والمادة');
                    if (!val) return alert('يرجى كتابة الدرجة');

                    e.target.innerText = 'جاري الحفظ...';
                    e.target.disabled = true;

                    // Save to Firebase
                    firebase.database().ref('users/' + uid + '/grades/' + sub).set(val)
                        .then(() => {
                            alert(`✅ تم رصد الدرجة (${val}) للطالب بنجاح في السحابة!`);
                            e.target.innerText = 'رصد الدرجة';
                            e.target.disabled = false;
                            // Update UI Status
                            const statusCell = document.getElementById('status-' + uid);
                            if (statusCell) { statusCell.innerText = 'تم التقييم'; statusCell.style.color = '#0f0'; }
                        })
                        .catch(err => {
                            alert('❌ خطأ في الحفظ: ' + err.message);
                            e.target.innerText = 'رصد الدرجة';
                            e.target.disabled = false;
                        });
                }
            });

            // Render Student Dashboard (Firebase Grades)
            function renderStudentDashboard(user) {
                const nameEl = document.getElementById('std-welcome-name');
                const majorEl = document.getElementById('std-welcome-major');
                if (nameEl) nameEl.innerText = user.name || 'طالب';
                if (majorEl) majorEl.innerText = user.major || 'مرحلة أولى';

                const tbody = document.getElementById('std-grades-body');
                if (!tbody) return;
                tbody.innerHTML = '';

                if (!user.grades) {
                    tbody.innerHTML = '<tr><td colspan="3">لا توجد درجات مرصودة حتى الآن</td></tr>';
                    return;
                }

                Object.keys(user.grades).forEach(sub => {
                    const gr = parseInt(user.grades[sub]);
                    let est = '';
                    let color = '#fff';

                    if (gr >= 90) { est = 'امتياز 🌟'; color = 'gold'; }
                    else if (gr >= 80) { est = 'جيد جداً'; color = '#0f0'; }
                    else if (gr >= 70) { est = 'جيد'; color = '#0ff'; }
                    else if (gr >= 60) { est = 'متوسط'; color = '#ff0'; }
                    else if (gr >= 50) { est = 'مقبول'; color = 'orange'; }
                    else { est = 'راسب ⚠️'; color = 'red'; }

                    tbody.innerHTML += `
                    <tr>
                        <td style="color:#ddd">${sub}</td>
                        <td style="font-weight:bold; font-size:1.1rem; color:${color}">${gr}</td>
                        <td style="color:${color}">${est}</td>
                    </tr>
                `;
                });
            }


            // ================== GRADEBOOK SYSTEM (EXCEL VIEW) ==================
            let gbClassId = '';
            let gbSubject = '';
            let gbStudents = []; // Array of {uid, name, gradesObj}

            function openGradebook() {
                // 1. Get Values
                const classSelect = document.getElementById('teacher-class-select');
                const subjectSelect = document.getElementById('teacher-subject-select');

                gbClassId = classSelect.value;
                gbSubject = subjectSelect.value;

                // 2. Validate
                if (!gbClassId) return alert("⚠️ يرجى اختيار الشعبة أولاً");
                if (!gbSubject) return alert("⚠️ يرجى اختيار المادة أولاً");

                // 3. Update UI Headers
                document.getElementById('gb-subject').innerText = gbSubject;
                document.getElementById('gb-class').innerText = gbClassId;

                // 4. Show Overlay (Force Display)
                const ov = document.getElementById('gradebook-overlay');
                ov.style.display = 'block';
                ov.style.opacity = '1';
                ov.style.visibility = 'visible';
                ov.style.zIndex = '9999999';
                requestAnimationFrame(() => ov.classList.add('active'));

                // 5. Render
                renderGradebook();
            }

            function closeGradebook() {
                const ov = document.getElementById('gradebook-overlay');
                ov.classList.remove('active');
                setTimeout(() => ov.style.display = 'none', 300);
            }

            function renderGradebook() {
                const thead = document.querySelector('#gradebook-master-table thead');
                const tbody = document.getElementById('gradebook-body');
                tbody.innerHTML = '<tr><td colspan="20">جاري تحميل البيانات من السحابة...</td></tr>';

                // HEADER STRUCTURE
                thead.innerHTML = `
                <tr>
                    <th rowspan="3" style="width:50px;">ت</th>
                    <th rowspan="3" style="width:250px;">اسم الطالب الثلاثي</th>
                    <th colspan="7" style="background:#ffebcc">تقسيم درجة الفصل الأول - الشهر الأول</th>
                    <th colspan="7" style="background:#ccffcc">تقسيم درجة الفصل الأول - الشهر الثاني</th>
                    <th rowspan="3" style="background:#ffff99; width:80px;">معدل الفصل الأول<br>(100%)</th>
                    <th rowspan="3" style="background:#ffcccc; width:80px;">نصف السنة<br>(100%)</th>
                </tr>
                <tr>
                    <th colspan="5" style="background:#fff2e6">الشفوي (20%)</th>
                    <th rowspan="2" style="background:#ffebcc">تحريري<br>(80)</th>
                    <th rowspan="2" style="background:#ffcc99">المحصلة<br>(100)</th>
                    
                    <th colspan="5" style="background:#e6fffa">الشفوي (20%)</th>
                    <th rowspan="2" style="background:#ccffcc">تحريري<br>(80)</th>
                    <th rowspan="2" style="background:#99ff99">المحصلة<br>(100)</th>
                </tr>
                <tr>
                    <th style="font-size:0.7rem">حضور (5)</th><th style="font-size:0.7rem">يومي (5)</th><th style="font-size:0.7rem">دفتر (5)</th><th style="font-size:0.7rem">سلوك (5)</th><th style="font-size:0.7rem; font-weight:bold">مجموع (20)</th>
                    <th style="font-size:0.7rem">حضور (5)</th><th style="font-size:0.7rem">يومي (5)</th><th style="font-size:0.7rem">دفتر (5)</th><th style="font-size:0.7rem">سلوك (5)</th><th style="font-size:0.7rem; font-weight:bold">مجموع (20)</th>
                </tr>
            `;

                // FETCH DATA
                firebase.database().ref('users').once('value').then(snapshot => {
                    const users = snapshot.val() || {};
                    gbStudents = [];

                    Object.keys(users).forEach(uid => {
                        const u = users[uid];
                        if (u.role === 'student' && u.major === gbClassId) { // Filter by Class
                            // Get Existing Grade Data for this Subject
                            const g = (u.gradesDetail && u.gradesDetail[gbSubject]) ? u.gradesDetail[gbSubject] : {};
                            gbStudents.push({ uid: uid, name: u.name, data: g });
                        }
                    });

                    // RENDER ROWS
                    tbody.innerHTML = '';
                    if (gbStudents.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="20">لا يوجد طلاب</td></tr>';
                        return;
                    }

                    gbStudents.forEach((s, index) => {
                        const d = s.data || {}; // Saved Data Interafce
                        const bg = index % 2 === 0 ? '#fff' : '#f9f9f9';

                        // Helper to generate Input
                        const inp = (key, max, val) => `<input type="number" id="${key}_${s.uid}" value="${val || ''}" max="${max}" onchange="calcGB('${s.uid}')" placeholder="-">`;
                        const read = (key, val) => `<input type="number" id="${key}_${s.uid}" value="${val || ''}" disabled style="background:rgba(0,0,0,0.05); font-weight:bold;">`;

                        const row = `
                    <tr style="background:${bg}">
                        <td>${index + 1}</td>
                        <td style="text-align:right; padding-right:10px;">${s.name}</td>
                        
                        <!-- Month 1 -->
                        <td>${inp('m1_att', 5, d.m1_att)}</td>
                        <td>${inp('m1_quiz', 5, d.m1_quiz)}</td>
                        <td>${inp('m1_note', 5, d.m1_note)}</td>
                        <td>${inp('m1_beh', 5, d.m1_beh)}</td>
                        <td style="background:#fff2e6">${read('m1_oral', d.m1_oral)}</td>
                        <td>${inp('m1_exam', 80, d.m1_exam)}</td>
                        <td style="background:#ffcc99">${read('m1_total', d.m1_total)}</td>
                        
                        <!-- Month 2 -->
                        <td>${inp('m2_att', 5, d.m2_att)}</td>
                        <td>${inp('m2_quiz', 5, d.m2_quiz)}</td>
                        <td>${inp('m2_note', 5, d.m2_note)}</td>
                        <td>${inp('m2_beh', 5, d.m2_beh)}</td>
                        <td style="background:#e6fffa">${read('m2_oral', d.m2_oral)}</td>
                        <td>${inp('m2_exam', 80, d.m2_exam)}</td>
                        <td style="background:#99ff99">${read('m2_total', d.m2_total)}</td>
                        
                        <!-- Sem 1 & Mid -->
                        <td style="background:#ffff99">${read('sem1_avg', d.sem1_avg)}</td>
                        <td style="background:#ffcccc">${inp('mid_year', 100, d.mid_year)}</td>
                    </tr>
                    `;
                        tbody.innerHTML += row;
                    });
                });
            }

            function calcGB(uid) {
                const val = (k) => parseFloat(document.getElementById(`${k}_${uid}`).value) || 0;
                const set = (k, v) => document.getElementById(`${k}_${uid}`).value = v;

                // Month 1
                const m1_oral = Math.min(20, val('m1_att') + val('m1_quiz') + val('m1_note') + val('m1_beh'));
                set('m1_oral', m1_oral);
                const m1_total = Math.min(100, m1_oral + val('m1_exam'));
                set('m1_total', m1_total);

                // Month 2
                const m2_oral = Math.min(20, val('m2_att') + val('m2_quiz') + val('m2_note') + val('m2_beh'));
                set('m2_oral', m2_oral);
                const m2_total = Math.min(100, m2_oral + val('m2_exam'));
                set('m2_total', m2_total);

                // Sem 1 Average
                // Assume Average of Ends? Or Sum? Usually Average of M1 + M2.
                const sem1 = Math.round((m1_total + m2_total) / 2);
                set('sem1_avg', sem1);
            }

            function saveGradebookAll() {
                const btn = document.querySelector('#gradebook-overlay button');
                btn.innerText = 'جاري الحفظ...';

                let updates = {};
                gbStudents.forEach(s => {
                    const val = (k) => document.getElementById(`${k}_${s.uid}`).value;
                    const data = {
                        m1_att: val('m1_att'), m1_quiz: val('m1_quiz'), m1_note: val('m1_note'), m1_beh: val('m1_beh'), m1_oral: val('m1_oral'), m1_exam: val('m1_exam'), m1_total: val('m1_total'),
                        m2_att: val('m2_att'), m2_quiz: val('m2_quiz'), m2_note: val('m2_note'), m2_beh: val('m2_beh'), m2_oral: val('m2_oral'), m2_exam: val('m2_exam'), m2_total: val('m2_total'),
                        sem1_avg: val('sem1_avg'), mid_year: val('mid_year')
                    };
                    // Save Detail
                    updates[`users/${s.uid}/gradesDetail/${gbSubject}`] = data;
                    // Sync Simple Grade (For Student Dash View) - Use Sem1 Avg or Mid??
                    // Let's use Sem1 Avg for now as the 'Grade'.
                    if (data.sem1_avg) updates[`users/${s.uid}/grades/${gbSubject}`] = data.sem1_avg;
                });

                firebase.database().ref().update(updates).then(() => {
                    alert('✅ تم حفظ السجل وتحديث درجات الطلاب بنجاح!');
                    btn.innerText = '💾 حفظ السجل';
                }).catch(e => alert(e.message));
            }

            // ================== AI ASSISTANT LOGIC ==================
            function toggleAI() {
                const ui = document.getElementById('ai-interface');
                const isOpen = ui.classList.contains('open');
                if (isOpen) {
                    ui.classList.remove('open');
                    setTimeout(() => ui.style.display = 'none', 300);
                } else {
                    ui.style.display = 'flex';
                    // Small delay to allow display:flex to apply before adding class for transition
                    setTimeout(() => ui.classList.add('open'), 10);
                    speak("أهلاً بك في إعدادية النهرين المهنية");
                }
            }

            function handleAIKey(e) { if (e.key === 'Enter') sendAIMessage(); }

            function sendAIMessage() {
                const input = document.getElementById('ai-input');
                const txt = input.value.trim();
                if (!txt) return;

                // Add User Message
                addMsg(txt, 'user');
                input.value = '';

                // Process
                setTimeout(() => {
                    const reply = processAI(txt);
                    addMsg(reply.text, 'bot');
                    speak(reply.voice || reply.text);
                }, 600);
            }

            function addMsg(txt, type) {
                const chat = document.getElementById('ai-messages');
                const div = document.createElement('div');
                div.className = `ai-msg ${type}`;
                div.innerText = txt;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            }

            function processAI(q) {
                q = q.toLowerCase();

                // Logic Matches
                if (q.includes('تسجيل') || q.includes('تقديم') || q.includes('قبول'))
                    return { text: "يمكنك التقديم عبر الاستمارة الإلكترونية الموجودة في القائمة الرئيسية. التسجيل مفتوح حالياً.", voice: "التسجيل مفتوح عبر الاستمارة الإلكترونية" };

                if (q.includes('مكان') || q.includes('عنوان') || q.includes('موقع'))
                    return { text: "تقع إعدادية النهرين في المثنى - السماوة - حي المعلمين.", voice: "موقعنا في السماوة حي المعلمين" };

                if (q.includes('مدير') || q.includes('إدارة'))
                    return { text: "مدير المدرسة هو الأستاذ الفاضل (أحمد مهند) - دكتوراه في تكنولوجيا التعليم.", voice: "مدير المدرسة هو الأستاذ أحمد مهند" };

                if (q.includes('قسم') || q.includes('تخصص') || q.includes('فروع'))
                    return { text: "التخصصات المتوفرة: 1. الأمن السيبراني 2. تكرير النفط 3. الأجهزة الطبية 4. الطيران.", voice: "لدينا أقسام مميزة كالأمن السيبراني وتكرير النفط" };

                if (q.includes('دوام') || q.includes('وقت'))
                    return { text: "الدوام يبدأ الساعة 8:00 صباحاً وينتهي الساعة 1:30 ظهراً.", voice: "الدوام من الثامنة للواحدة والنصف" };

                if (q.includes('مرحبا') || q.includes('هلا') || q.includes('السلام'))
                    return { text: "أهلاً بك! كيف يمكنني مساعدتك اليوم؟ 😊", voice: "أهلا بك في مدرستنا" };

                return { text: "عذراً، لم أفهم السؤال تماماً. يمكنك سؤالي عن التقديم، الأقسام، أو الموقع.", voice: "لم أفهم السؤال، جرب صياغة أخرى" };
            }

            function speak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'ar-SA';
                    u.rate = 1.1;
                    u.pitch = 1;
                    window.speechSynthesis.speak(u);
                }
            }



        </script>

        <!-- NEW GRADEBOOK OVERLAY (Relocated for Z-Index Safety) -->
        <div id="gradebook-overlay" class="dashboard-overlay"
            style="z-index: 999999; background: #fff; color: #000; overflow:hidden; position:fixed; top:0; left:0; width:100%; height:100%; display:none;">

            <i class="fa-solid fa-xmark close-dash"
                style="color:red; z-index:1000000; position:absolute; left:20px; top:20px; font-size:2rem; cursor:pointer;"
                onclick="closeGradebook()"></i>

            <div class="container"
                style="width: 100%; height: 100%; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box;">

                <!-- Header -->
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                    <div style="text-align: right;">
                        <h2 style="color:black; font-family:'Cairo'; font-size:1.5rem; margin:0;">سجل درجات المدرسين
                            /
                            اعدادية النهرين المهنية</h2>
                        <p style="margin:5px 0 0 0; font-size:1rem;">العام الدراسي 2024-2025</p>
                    </div>
                    <div style="text-align: center;">
                        <h3 style="margin:0; color:#000;">المادة: <span id="gb-subject" style="color:blue">--</span>
                        </h3>
                        <h4 style="margin:0; color:#000;">الصف: <span id="gb-class" style="color:red">--</span></h4>
                    </div>
                    <div>
                        <button class="btn-glow"
                            style="background:#00d26a; width:150px; color:#fff; text-shadow:none; font-weight:bold;"
                            onclick="saveGradebookAll()">💾 حفظ السجل</button>
                    </div>
                </div>

                <!-- Table Container -->
                <div style="flex: 1; overflow: auto; border: 2px solid #000; position:relative;">
                    <table class="gradebook-table" id="gradebook-master-table"
                        style="width: 100%; border-collapse: collapse; min-width: 1500px;">
                        <thead style="position: sticky; top: 0; z-index: 10; background: #e0e0e0;">
                            <!-- Generated by JS -->
                        </thead>
                        <tbody id="gradebook-body">
                            <!-- JS Generated Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Assistant (Moved to Root) -->
        <div id="ai-orb" onclick="toggleAI()">
            <div class="orb-core"></div>
            <div class="orb-ring ring-1"></div>
            <div class="orb-ring ring-2"></div>
            <div class="orb-ring ring-3"></div>
        </div>

        <div id="ai-interface" class="glass-panel">
            <div class="ai-header">
                <span><i class="fa-solid fa-robot"></i> المساعد (Nahr-AI)</span>
                <i class="fa-solid fa-xmark close-ai" onclick="toggleAI()"></i>
            </div>
            <div id="ai-messages">
                <div class="ai-msg bot">مرحباً بك! 👋<br>أنا مساعدك الذكي.<br>اسألني عن: التقديم، الأقسام، المدير،
                    أو
                    الموقع.</div>
            </div>

            <!-- Suggestions -->
            <div class="ai-suggestions"
                style="padding: 10px; display:flex; gap:5px; flex-wrap:wrap; justify-content:center;">
                <button class="btn-glow" style="font-size:0.7rem; padding:5px 10px;"
                    onclick="document.getElementById('ai-input').value='من المدير؟'; sendAIMessage()">من
                    المدير؟</button>
                <button class="btn-glow" style="font-size:0.7rem; padding:5px 10px;"
                    onclick="document.getElementById('ai-input').value='التخصصات'; sendAIMessage()">التخصصات</button>
                <button class="btn-glow" style="font-size:0.7rem; padding:5px 10px;"
                    onclick="document.getElementById('ai-input').value='اين الموقع؟'; sendAIMessage()">الموقع</button>
            </div>

            <div class="ai-input-area">
                <input type="text" id="ai-input" placeholder="اكتب سؤالك هنا..." onkeypress="handleAIKey(event)">
                <i class="fa-solid fa-paper-plane" onclick="sendAIMessage()"
                    style="cursor: pointer; color: var(--secondary); font-size: 1.2rem;"></i>
            </div>
        </div>
        <!-- CUSTOM MODAL (Replaces Alert/Confirm) -->
        <div id="custom-modal"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center; backdrop-filter:blur(5px);">
            <div class="glass-panel"
                style="max-width:400px; width:90%; text-align:center; transform:scale(0.9); transition:transform 0.3s;">
                <i id="modal-icon" class="fa-solid fa-circle-info"
                    style="font-size:3rem; margin-bottom:15px; color:var(--primary);"></i>
                <h3 id="modal-title" style="color:#fff; margin-bottom:10px;">تنبيه</h3>
                <p id="modal-msg" style="color:#ccc; margin-bottom:20px; line-height:1.6; font-size:1.1rem;"></p>
                <div id="modal-actions" style="display:flex; justify-content:center; gap:10px;">
                    <button id="btn-modal-ok" class="btn-glow" onclick="closeModal()">موافق</button>
                </div>
            </div>
        </div>

        <script>
            // === CUSTOM MODAL SYSTEM ===
            function showAlert(msg, title = 'تنبيه', icon = 'fa-circle-info', color = 'var(--primary)') {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-msg').innerText = msg;

                const iconEl = document.getElementById('modal-icon');
                iconEl.className = `fa-solid ${icon}`;
                iconEl.style.color = color;

                document.getElementById('modal-actions').innerHTML = `<button class="btn-glow" onclick="closeModal()">موافق</button>`;

                openModal();
            }

            function showConfirm(msg, onYes) {
                document.getElementById('modal-title').innerText = 'تأكيد الإجراء';
                document.getElementById('modal-msg').innerText = msg;

                const iconEl = document.getElementById('modal-icon');
                iconEl.className = 'fa-solid fa-triangle-exclamation';
                iconEl.style.color = 'orange';

                const actions = document.getElementById('modal-actions');
                actions.innerHTML = '';

                const btnNo = document.createElement('button');
                btnNo.className = 'btn-glow';
                btnNo.style.background = '#444';
                btnNo.style.borderColor = '#666';
                btnNo.innerText = 'إلغاء';
                btnNo.onclick = closeModal;

                const btnYes = document.createElement('button');
                btnYes.className = 'btn-glow';
                btnYes.style.background = 'red';
                btnYes.style.borderColor = 'red';
                btnYes.innerText = 'نعم، تابع';
                btnYes.onclick = function () {
                    onYes();
                    closeModal();
                };

                actions.appendChild(btnNo);
                actions.appendChild(btnYes);

                openModal();
            }

            function openModal() {
                const modal = document.getElementById('custom-modal');
                modal.style.display = 'flex';
                // Small delay for animation
                requestAnimationFrame(() => {
                    modal.querySelector('.glass-panel').style.transform = 'scale(1)';
                });
            }

            function closeModal() {
                const modal = document.getElementById('custom-modal');
                modal.querySelector('.glass-panel').style.transform = 'scale(0.9)';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 200);
            }

            // === OVERRIDE ADMIN FUNCTIONS TO USE MODAL ===
            // We redefine these functions here to ensure they use showAlert/showConfirm
            // instead of the browser native ones defined earlier in the file.

            window.performAddStaff = function () {
                const name = document.getElementById('new-staff-name').value;
                const codeInput = document.getElementById('new-staff-code');
                const code = editingStaffCode || codeInput.value;
                const role = document.getElementById('new-staff-role').value;
                const subs = document.getElementById('new-staff-subjects').value;

                if (!name || !code) return showAlert("يرجى ملء الاسم ورمز الدخول", "بيانات ناقصة", "fa-circle-xmark", "red");

                const db = getStaffDB();

                if (!editingStaffCode && db[code]) return showAlert("هذا الكود مستخدم بالفعل!", "خطأ", "fa-circle-xmark", "red");

                const subjectArray = subs ? subs.split(',').map(s => s.trim()) : [];
                if (role === 'admin' && subjectArray.length === 0) subjectArray.push('ALL');

                db[code] = { name, code, role, subjects: subjectArray };
                saveStaffDB(db);

                const wasEditing = editingStaffCode;
                editingStaffCode = null;
                renderAdminLists();

                showAlert(wasEditing ? "تم تحديث بيانات المستخدم بنجاح" : "تمت إضافة المستخدم الجديد بنجاح", "تمت العملية", "fa-circle-check", "#0f0");
            };

            window.performRemoveStaff = function (code) {
                showConfirm("هل أنت متأكد من حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.", () => {
                    const db = getStaffDB();
                    delete db[code];
                    saveStaffDB(db);
                    renderAdminLists();
                    showAlert("تم حذف المستخدم من النظام", "تم الحذف", "fa-trash", "orange");
                });
            };

            // Similarly override deleteApp
            window.deleteApp = function (id) {
                showConfirm("هل أنت متأكد من حذف هذا الطلب؟", () => {
                    let db = getAppsDB();
                    db = db.filter(a => a.id != id);
                    saveAppsDB(db);
                    renderAdminLists();
                    showAlert("تم حذف الطلب بنجاح", "تم", "fa-check");
                });
            }
            window.performEditStaff = function (code) {
                const db = getStaffDB();
                const staff = db[code];
                if (!staff) return;

                editingStaffCode = code;
                renderAdminLists(); // Switch UI

                setTimeout(() => {
                    document.getElementById('new-staff-name').value = staff.name;
                    document.getElementById('new-staff-code').value = staff.code;
                    document.getElementById('new-staff-subjects').value = (staff.subjects || []).join(', ');
                    document.getElementById('new-staff-role').value = staff.role;
                    document.getElementById('new-staff-name').focus();
                }, 50);
            };

            window.performCancelEdit = function () {
                editingStaffCode = null;
                renderAdminLists();
            };
        </script>
        <script>
            // SW Disabled in Simulation
            console.log("Service Worker disabled in Simulation Mode");
        </script>
    </div> <!-- END WEB CONTENT HIDDEN -->

    </div> <!-- END SIM CONTENT -->

    <!-- 3. BOTTOM TAB BAR -->
    <div class="app-bottom-nav">
        <a href="javascript:void(0)" onclick="switchAppTab('home')" class="nav-item active">
            <i class="fa-solid fa-house"></i>
            <span>الرئيسية</span>
        </a>
        <a href="javascript:void(0)" onclick="switchAppTab('specs')" class="nav-item">
            <i class="fa-solid fa-layer-group"></i>
            <span>الأقسام</span>
        </a>
        <a href="javascript:void(0)" class="nav-item"
            onclick="document.getElementById('admission-section').scrollIntoView(); switchAppTab('specs')">
            <div
                style="background:var(--primary); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:5px; margin-top:-20px; box-shadow: 0 0 10px var(--primary); color:#000;">
                <i class="fa-solid fa-plus" style="margin:0; font-size:1.2rem;"></i>
            </div>
        </a>
        <a href="javascript:void(0)" onclick="switchAppTab('profile')" class="nav-item">
            <i class="fa-solid fa-user"></i>
            <span>حسابي</span>
        </a>
        <a href="javascript:void(0)" onclick="switchAppTab('contact')" class="nav-item">
            <i class="fa-solid fa-phone"></i>
            <span>اتصل</span>
        </a>
    </div>

    <!-- FLOATING ACTION BUTTON (Apply) -->
    <!-- <div class="fab-apply" onclick="document.getElementById('admission-section').scrollIntoView()">
                <i class="fa-solid fa-file-pen"></i>
            </div> -->

    <!-- Home Indicator -->
    <div class="home-indicator"></div>

    </div> <!-- END SIM FRAME -->
</body>

</html>